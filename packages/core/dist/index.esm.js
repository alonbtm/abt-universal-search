const e={dataSource:{type:"memory"},queryHandling:{minLength:3,debounceMs:300,triggerOn:"change",caseSensitive:!1,matchMode:"partial",debounceStrategy:"trailing",caseNormalization:"lowercase",xssProtection:!0,sqlInjectionProtection:!0,performanceMonitoring:!0},ui:{maxResults:10,placeholder:"Search...",loadingText:"Loading...",noResultsText:"No results found",theme:"default",rtl:!1},debug:!1,classPrefix:"universal-search"};class t extends Error{constructor(e,t){super(e),this.field=t,this.name="ValidationError"}}class i{constructor(e){this.connections=new Map,this.metrics=new Map,this.adapterType=e}get type(){return this.adapterType}async healthCheck(e){try{return"connected"===e.status}catch{return!1}}getActiveConnections(){return Array.from(this.connections.values()).filter(e=>"connected"===e.status)}getConnection(e){return this.connections.get(e)}getConnectionMetrics(e){if(e)return this.metrics.get(e)||[];const t=[];for(const e of this.metrics.values())t.push(...e);return t}createConnection(e,t={}){const i={id:e,adapterType:this.adapterType,status:"connecting",createdAt:Date.now(),lastUsedAt:Date.now(),metadata:{...t}};return this.connections.set(e,i),i}updateConnectionStatus(e,t,i){const s=this.connections.get(e);s&&(s.status=t,s.lastUsedAt=Date.now(),i&&(s.metadata={...s.metadata,...i}))}removeConnection(e){this.connections.delete(e),this.metrics.delete(e)}recordMetrics(e,t){this.metrics.has(e)||this.metrics.set(e,[]);const i=this.metrics.get(e);i.push(t),i.length>100&&i.splice(0,i.length-100)}createError(e,t,i,s,r){const n=new Error(e);switch(n.type=t,n.code=i,s&&(n.originalError=s),n.context={adapter:this.adapterType,timestamp:Date.now(),...r},t){case"connection":n.recovery={retryable:!0,suggestions:["Check network connectivity","Verify connection configuration","Ensure service is running"],fallbackOptions:["Use cached results","Try alternative adapter"]};break;case"timeout":n.recovery={retryable:!0,suggestions:["Increase timeout configuration","Optimize query complexity","Check system performance"]};break;case"validation":n.recovery={retryable:!1,suggestions:["Check configuration format","Verify required fields","Review data types"]};break;default:n.recovery={retryable:!0,suggestions:["Check logs for details","Try again later"]}}return n}async executeWithMetrics(e,t,i){const s=performance.now();let r=!1,n=0;try{const e=await t();return r=!0,Array.isArray(e)&&(n=e.length),e}finally{const t=performance.now()-s;this.recordMetrics(e,{connectionTime:0,queryTime:"query"===i?t:0,totalTime:t,success:r,resultCount:n})}}async destroy(){const e=Array.from(this.connections.values()).map(e=>this.disconnect(e).catch(()=>{}));await Promise.allSettled(e),this.connections.clear(),this.metrics.clear()}}class s extends i{constructor(e){super("memory"),this.isValidated=!1;const i=this.normalizeConfig(e);if(!i)throw new t("MemoryAdapter requires configuration");this.config={type:"memory",caseSensitive:!1,updateStrategy:"static",searchFields:[],data:[],...i},this.data=Array.isArray(this.config.data)?[...this.config.data]:"function"==typeof this.config.data?[...this.config.data()]:[];try{this.validateConfigSync(this.config),this.isValidated=!0}catch(e){throw e}}normalizeConfig(e){if(!e)return null;const t=e;return t.data&&t.searchFields?{type:"memory",data:t.data,searchFields:t.searchFields,caseSensitive:t.caseSensitive||!1,updateStrategy:"static"}:t}async connect(e){const t=e;await this.validateConfig(t);const i=`memory-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,s=this.createConnection(i,{config:t});return this.updateConnectionStatus(i,"connected"),s}async query(e,t){return this.executeWithMetrics(e.id,async()=>this.search(t.normalized).map((e,i)=>({id:`memory_${i}_${Date.now()}`,data:e.item,score:e.score,matchedFields:e.matchedFields,metadata:{matchedFields:e.matchedFields,adapterType:"memory",searchQuery:t.normalized}})),"query")}async disconnect(e){this.updateConnectionStatus(e.id,"disconnected"),this.removeConnection(e.id)}async validateConfig(e){const i=e;if("memory"!==i.type)throw new t('Config type must be "memory" for MemoryAdapter');this.validateConfigSync(i)}getCapabilities(){return{supportsPooling:!1,supportsRealTime:"reactive"===this.config.updateStrategy,supportsPagination:!0,supportsSorting:!0,supportsFiltering:!0,maxConcurrentConnections:100,supportedQueryTypes:["text","partial","exact"]}}search(e){if(!this.isValidated)throw new t("Adapter configuration is invalid");if(!e||"string"!=typeof e)return[];const i=this.normalizeQuery(e);if(0===i.length)return[];const s=[];for(const e of this.data){const t=this.matchItem(e,i);t.score>0&&s.push({item:e,score:t.score,matchedFields:t.matchedFields})}return s.sort((e,t)=>t.score-e.score)}updateData(e){if(!Array.isArray(e))throw new t("Data must be an array");this.data=[...e],this.validateData()}getData(){return[...this.data]}getConfig(){return{...this.config,data:Array.isArray(this.config.data)?this.config.data:[]}}validateConfigSync(e){const i=Array.isArray(e.data)?e.data:"function"==typeof e.data?e.data():null;if(!Array.isArray(i))throw new t("Data must be an array or function returning an array","data");if(!Array.isArray(e.searchFields)||0===e.searchFields.length)throw new t("searchFields must be a non-empty array","searchFields");for(const i of e.searchFields)if("string"!=typeof i||0===i.trim().length)throw new t("All searchFields must be non-empty strings","searchFields");Array.isArray(i)&&(this.data=[...i]),this.validateData()}validateData(){if(0===this.data.length)return;const e=Math.min(3,this.data.length);for(let i=0;i<e;i++){const e=this.data[i];if(!e||"object"!=typeof e)throw new t(`Data item at index ${i} must be an object`,"data");for(const i of this.config.searchFields){const s=this.getFieldValue(e,i);if(null!=s&&"string"!=typeof s&&"number"!=typeof s)throw new t(`Field "${i}" must be string or number type in data items`,"searchFields")}}}normalizeQuery(e){const t=e.trim();return this.config.caseSensitive?t:t.toLowerCase()}matchItem(e,t){if(!e||"object"!=typeof e)return{score:0,matchedFields:[]};let i=0;const s=[];for(const r of this.config.searchFields){const n=this.getFieldValue(e,r);if(null==n)continue;const a=String(n),o=this.config.caseSensitive?a:a.toLowerCase();if(o.includes(t)){let e=1;e=o===t?10:o.startsWith(t)?5:1,i+=e,s.push(r)}}return{score:i,matchedFields:s}}getFieldValue(e,t){if(!e||"object"!=typeof e)return null;const i=t.split(".");let s=e;for(const e of i){if(!s||"object"!=typeof s||!(e in s))return null;s=s[e]}return s}}const r=[/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,/javascript:/gi,/on\w+\s*=/gi,/style\s*=/gi,/%3c/gi,/%3e/gi,/&lt;script/gi,/&lt;\/script&gt;/gi,/vbscript:/gi,/data:text\/html/gi],n=[/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b)/gi,/(;|\||&|\$|\+|--|\/\*|\*\/|xp_|sp_)/gi,/(\b(OR|AND)\s+\d+\s*=\s*\d+)/gi,/(\b(OR|AND)\s+['"]\w+['"]?\s*=\s*['"]\w+['"]?)/gi,/'(\s|%20)*(or|and)(\s|%20)*'/gi,/"(\s|%20)*(or|and)(\s|%20)*"/gi,/(\bunion\s+(all\s+)?select)/gi];function a(e,t={}){if("string"!=typeof e)return"";const{xssProtection:i=!0,sqlInjectionProtection:s=!0}=t;let a=e;return i&&(a=function(e){if("string"!=typeof e)return"";let t=e;return r.forEach(e=>{t=t.replace(e,"")}),t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"),t}(a)),s&&(a=function(e){if("string"!=typeof e)return"";let t=e;return n.forEach(e=>{t=t.replace(e,"")}),t=t.replace(/'/g,"''"),t}(a)),a}function o(e){return"string"==typeof e&&r.some(t=>t.test(e))}function c(e){return"string"==typeof e&&n.some(t=>t.test(e))}function l(e,t={}){const{xssProtection:i=!0,sqlInjectionProtection:s=!0}=t,r={xss:!!i&&o(e),sqlInjection:!!s&&c(e)};return{isSecure:!r.xss&&!r.sqlInjection,threats:r,sanitized:a(e,t)}}const u=new class{constructor(){this.metrics=new Map,this.currentOperation=new Map}startTracking(e,t,i){const s=performance.now(),r=this.getMemoryUsage();this.currentOperation.set(e,{startTime:s,queryLength:t,validationRulesCount:i,...void 0!==r&&{memoryBefore:r}})}endTracking(e){const t=this.currentOperation.get(e);if(!t||!t.startTime)return null;const i=performance.now(),s=i-t.startTime,r=this.getMemoryUsage(),n={startTime:t.startTime,endTime:i,duration:s,queryLength:t.queryLength||0,validationRulesCount:t.validationRulesCount||0,...void 0!==t.memoryBefore&&{memoryBefore:t.memoryBefore},...void 0!==r&&{memoryAfter:r}},a=this.metrics.get(e)||[];return a.push(n),this.metrics.set(e,a),this.currentOperation.delete(e),n}getMetrics(e){return this.metrics.get(e)||[]}getAllMetrics(e=""){const t=[];for(const[i,s]of this.metrics.entries())(""===e||i.includes(e))&&t.push(...s);return t}getAverageMetrics(e){const t=this.getMetrics(e);if(0===t.length)return null;const i=t.reduce((e,t)=>({duration:e.duration+t.duration,queryLength:e.queryLength+t.queryLength,validationRulesCount:e.validationRulesCount+t.validationRulesCount}),{duration:0,queryLength:0,validationRulesCount:0});return{duration:i.duration/t.length,queryLength:i.queryLength/t.length,validationRulesCount:i.validationRulesCount/t.length}}clearMetrics(){this.metrics.clear(),this.currentOperation.clear()}getMemoryUsage(){if("undefined"!=typeof performance&&"memory"in performance)return performance.memory.usedJSHeapSize}};class h{constructor(e){this.debounceTimer=null,this.leadingTimer=null,this.queryCounter=0,this.lastExecutionTime=0,this.config={enableSecurityValidation:!0,enableXSSProtection:!0,enableSQLInjectionProtection:!0,enablePerformanceMonitoring:!0,customValidators:[],debounceStrategy:"trailing",caseNormalization:"lowercase",enableStemming:!1,enablePreprocessing:!0,localization:{language:"en",messages:{minLength:"Please enter at least {minLength} characters",maxLength:"Query is too long (maximum {maxLength} characters)",invalidChars:"Query contains invalid characters",securityThreat:"Query contains potentially harmful content"}},...e},this.validateConfig()}processQuery(e){const t="query-"+ ++this.queryCounter,i=performance.now(),s=Date.now(),r=[];this.config.enablePerformanceMonitoring&&u.startTracking(t,"string"==typeof e?e.length:0,(this.config.customValidators?.length||0)+1);const n=e;if("string"!=typeof e){const e={processingTime:performance.now()-i,originalQuery:String(n),length:0,trimmed:!1,timestamp:s,...this.config.enablePerformanceMonitoring&&{performanceId:t},validationRulesApplied:["type-validation"]};return this.config.enablePerformanceMonitoring&&u.endTracking(t),this.createErrorResult(n,"Query must be a string",e)}const a=e.trim();let o,c,h=this.normalizeQuery(a);r.push("normalization"),this.config.enableSecurityValidation&&(o=l(h,{xssProtection:this.config.enableXSSProtection,sqlInjectionProtection:this.config.enableSQLInjectionProtection}),r.push("security-validation"),c=o.sanitized,o.isSecure||(h=c,r.push("sanitization")));const d=this.validateQuery(h);r.push("basic-validation");const m=[];if(this.config.customValidators&&this.config.customValidators.length>0)for(const e of this.config.customValidators)e.validator(h)||(m.push(e.errorMessage),r.push(`custom-${e.name}`));const p=[...d.errors,...m],f=0===p.length&&!1!==o?.isSecure,g=performance.now()-i;this.config.enablePerformanceMonitoring&&u.endTracking(t);return{original:n,normalized:h,...c&&{sanitized:c},isValid:f,...p.length>0&&{error:p[0]},...o&&{securityInfo:o},metadata:{processingTime:g,originalQuery:n,length:h.length,trimmed:n!==a,timestamp:s,...this.config.enablePerformanceMonitoring&&{performanceId:t},validationRulesApplied:r}}}validateInput(e){if("string"!=typeof e)return{isValid:!1,errors:["Query must be a string"]};const t=e.trim(),i=this.normalizeQuery(t);return this.validateQuery(i)}shouldTriggerSearch(e,t="change"){const i=this.config.triggerOn;return"both"===i||("change"===i&&"change"===t||"enter"===i&&"enter"===t)}debouncedProcess(e,t,i="change"){if(!this.shouldTriggerSearch(e,i))return;if(this.config.debounceMs<=0){return void t(this.processQuery(e))}const s=Date.now();switch(this.config.debounceStrategy||"trailing"){case"leading":this.executeLeadingDebounce(e,t,s);break;case"trailing":default:this.executeTrailingDebounce(e,t);break;case"both":this.executeBothDebounce(e,t,s)}}executeLeadingDebounce(e,t,i){if(i-this.lastExecutionTime>=this.config.debounceMs){t(this.processQuery(e)),this.lastExecutionTime=i,this.leadingTimer&&clearTimeout(this.leadingTimer),this.leadingTimer=window.setTimeout(()=>{this.leadingTimer=null},this.config.debounceMs)}}executeTrailingDebounce(e,t){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{const i=this.processQuery(e);t(i),this.debounceTimer=null,this.lastExecutionTime=Date.now()},this.config.debounceMs)}executeBothDebounce(e,t,i){if(i-this.lastExecutionTime>=this.config.debounceMs&&!this.leadingTimer){const s=this.processQuery(e);t(s),this.lastExecutionTime=i,this.leadingTimer=window.setTimeout(()=>{this.leadingTimer=null},this.config.debounceMs)}this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{const i=this.processQuery(e);t(i),this.debounceTimer=null,this.lastExecutionTime=Date.now()},this.config.debounceMs)}cancelPendingOperations(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.leadingTimer&&(clearTimeout(this.leadingTimer),this.leadingTimer=null)}destroy(){this.cancelPendingOperations()}getConfig(){return{...this.config}}getPerformanceMetrics(e){return this.config.enablePerformanceMonitoring?e?u.getMetrics(e):u.getAllMetrics("query"):[]}getPerformanceRecommendations(){if(!this.config.enablePerformanceMonitoring)return[];return function(e){const t=[];if(0===e.length)return t;const i=e.reduce((e,t)=>e+t.duration,0)/e.length,s=Math.max(...e.map(e=>e.duration)),r=e.reduce((e,t)=>e+t.queryLength,0)/e.length;return i>10&&t.push({type:"warning",message:"Average query processing time is high. Consider optimizing validation rules.",metric:"duration",threshold:10,currentValue:i}),s>50&&t.push({type:"critical",message:"Some queries are taking too long to process. Review complex validation patterns.",metric:"duration",threshold:50,currentValue:s}),r>100&&t.push({type:"info",message:"Users are entering long queries. Consider adding query length limits.",metric:"queryLength",threshold:100,currentValue:r}),t}(this.getPerformanceMetrics())}clearPerformanceMetrics(){this.config.enablePerformanceMonitoring&&u.clearMetrics()}normalizeQuery(e){let t=e;switch(t=t.trim(),this.config.enablePreprocessing&&(t=t.replace(/\s+/g," "),t=t.replace(/[\r\n\t]/g," "),t=t.replace(/[.,;:!?'"()[\]{}]/g,""),t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"")),this.config.caseNormalization){case"lowercase":t=t.toLowerCase();break;case"uppercase":t=t.toUpperCase();break;case"preserve":break;default:this.config.caseSensitive||(t=t.toLowerCase())}return this.config.enableStemming&&(t=this.applyStemming(t)),t}applyStemming(e){return e.split(" ").map(e=>e.length<=2?e:e.endsWith("ing")?e.slice(0,-3):e.endsWith("ed")||e.endsWith("er")?e.slice(0,-2):e.endsWith("est")?e.slice(0,-3):e.endsWith("ly")?e.slice(0,-2):e.endsWith("s")&&!e.endsWith("ss")?e.slice(0,-1):e).join(" ")}validateQuery(e){const t=[],i=[];let s="";const r={};if(e.length<this.config.minLength){const e=`Query must be at least ${this.config.minLength} characters long`;t.push(e),s=this.getLocalizedMessage("minLength",{minLength:this.config.minLength.toString()}),r.en=s,"en"!==this.config.localization?.language&&(r[this.config.localization?.language||"en"]=this.config.localization?.messages.minLength?.replace("{minLength}",this.config.minLength.toString())||s)}if(e.length>500){const e="Query is too long (maximum 500 characters)";t.push(e),s=this.getLocalizedMessage("maxLength",{maxLength:"500"}),r.en=s,"en"!==this.config.localization?.language&&(r[this.config.localization?.language||"en"]=this.config.localization?.messages.maxLength?.replace("{maxLength}","500")||s)}return(e.includes("<")||e.includes(">")||e.includes("&"))&&i.push("Query contains special characters that may be filtered"),{isValid:0===t.length,errors:t,warnings:i.length>0?i:void 0,userFriendlyMessage:s||void 0,localizedMessages:Object.keys(r).length>0?r:void 0,validationContext:{field:"query",value:e,rule:t.length>0?"length-validation":"valid"}}}getLocalizedMessage(e,t={}){let i=this.config.localization?.messages[e]||("minLength"===e?"Please enter at least {minLength} characters":"maxLength"===e?"Query is too long (maximum {maxLength} characters)":"Invalid input");for(const[e,s]of Object.entries(t))i=i.replace(`{${e}}`,s);return i}createErrorResult(e,t,i){return{original:e,normalized:"",isValid:!1,error:t,metadata:i}}validateConfig(){if("number"!=typeof this.config.minLength||this.config.minLength<0)throw new t("minLength must be a non-negative number","minLength");if(this.config.minLength>100)throw new t("minLength cannot exceed 100 characters","minLength");if("number"!=typeof this.config.debounceMs||this.config.debounceMs<0)throw new t("debounceMs must be a non-negative number","debounceMs");if(!["change","enter","both"].includes(this.config.triggerOn))throw new t("triggerOn must be one of: change, enter, both","triggerOn");if(!["exact","partial","fuzzy"].includes(this.config.matchMode))throw new t("matchMode must be one of: exact, partial, fuzzy","matchMode")}}new class{constructor(){this.enhancementRules=[],this.categoryMappings=new Map,this.iconMappings=new Map,this.customEnhancers=new Map,this.stats=this.initializeStats()}addRule(e){this.enhancementRules.push(e),this.sortRulesByPriority()}addRules(e){this.enhancementRules.push(...e),this.sortRulesByPriority()}addCategoryMapping(e,t){this.categoryMappings.set(e,t)}addIconMapping(e,t){this.iconMappings.set(e,t)}addCustomEnhancer(e,t){this.customEnhancers.set(e,t)}enhanceResult(e,t){const i=performance.now();this.stats.totalEnhancements++;const s={...e,metadata:{...e.metadata}};try{for(const e of this.enhancementRules)if(this.evaluateRuleConditions(e,s)){const i=e.enhance(s,t);Object.assign(s.metadata,i),this.stats.ruleExecutions[e.name]=(this.stats.ruleExecutions[e.name]||0)+1}this.applySubtitleEnhancement(s),this.applyIconEnhancement(s),this.applyCategoryEnhancement(s),this.applyCustomEnhancements(s),s.metadata.enhanced=!0,s.metadata.enhancementTime=performance.now()-i,this.stats.successfulEnhancements++}catch(e){s.metadata.enhancementError=e instanceof Error?e.message:String(e)}return this.updateStats(performance.now()-i),s}enhanceResults(e,t={}){return e.map((i,s)=>this.enhanceResult(i,{...t,index:s,totalResults:e.length,sourceType:t.sourceType||"unknown"}))}applySubtitleEnhancement(e){if(e.metadata.subtitle)return;const t=[e.description,e.metadata.description,e.metadata.summary,e.metadata.type,e.metadata.category];for(const i of t)if(i&&"string"==typeof i&&i.trim().length>0){e.metadata.subtitle=i.trim();break}if(!e.metadata.subtitle){const t=[];e.metadata.category&&"string"==typeof e.metadata.category&&t.push(e.metadata.category),e.metadata.type&&"string"==typeof e.metadata.type&&t.push(e.metadata.type),t.length>0&&(e.metadata.subtitle=t.join(" • "))}}applyIconEnhancement(e){if(e.metadata.icon)return;const t=[e.metadata.category,e.metadata.type,e.metadata.kind,this.extractFileExtension(e.title||e.url)].filter(e=>e&&"string"==typeof e);for(const i of t){const t=this.iconMappings.get(i);if(t){e.metadata.icon=t;break}}e.metadata.icon||(e.metadata.icon=this.getDefaultIcon(e))}applyCategoryEnhancement(e){if(e.metadata.categoryConfig)return;const t=e.metadata.category;if(t&&this.categoryMappings.has(t)){const i=this.categoryMappings.get(t);e.metadata.categoryConfig=i,!e.metadata.icon&&i.icon&&(e.metadata.icon=i.icon)}}applyCustomEnhancements(e){for(const[t,i]of this.customEnhancers)try{const t=i(e);Object.assign(e.metadata,t)}catch(e){}}evaluateRuleConditions(e,t){return!e.conditions||0===e.conditions.length||e.conditions.every(e=>{const i=this.getFieldValue(t,e.field);switch(e.operator){case"exists":return null!=i;case"equals":return i===e.value;case"contains":return"string"==typeof i&&"string"==typeof e.value&&i.toLowerCase().includes(e.value.toLowerCase());case"startsWith":return"string"==typeof i&&"string"==typeof e.value&&i.toLowerCase().startsWith(e.value.toLowerCase());case"endsWith":return"string"==typeof i&&"string"==typeof e.value&&i.toLowerCase().endsWith(e.value.toLowerCase());case"regex":return"string"==typeof i&&e.regex&&e.regex.test(i);default:return!1}})}getFieldValue(e,t){const i=t.split(".");let s=e;for(const e of i){if(!s||"object"!=typeof s||!(e in s))return null;s=s[e]}return s}getDefaultIcon(e){const t=e.url;if(e.title,t){const e=this.extractFileExtension(t);return e?this.getFileTypeIcon(e):t.includes("github.com")?{type:"font-icon",className:"fab fa-github",alt:"GitHub"}:t.includes("stackoverflow.com")?{type:"font-icon",className:"fab fa-stack-overflow",alt:"Stack Overflow"}:{type:"font-icon",className:"fas fa-external-link-alt",alt:"External Link"}}return{type:"font-icon",className:"fas fa-file",alt:"Document"}}getFileTypeIcon(e){return{pdf:{type:"font-icon",className:"fas fa-file-pdf",color:"#e74c3c",alt:"PDF"},doc:{type:"font-icon",className:"fas fa-file-word",color:"#2980b9",alt:"Word Document"},docx:{type:"font-icon",className:"fas fa-file-word",color:"#2980b9",alt:"Word Document"},xls:{type:"font-icon",className:"fas fa-file-excel",color:"#27ae60",alt:"Excel Spreadsheet"},xlsx:{type:"font-icon",className:"fas fa-file-excel",color:"#27ae60",alt:"Excel Spreadsheet"},ppt:{type:"font-icon",className:"fas fa-file-powerpoint",color:"#e67e22",alt:"PowerPoint"},pptx:{type:"font-icon",className:"fas fa-file-powerpoint",color:"#e67e22",alt:"PowerPoint"},jpg:{type:"font-icon",className:"fas fa-file-image",color:"#9b59b6",alt:"Image"},jpeg:{type:"font-icon",className:"fas fa-file-image",color:"#9b59b6",alt:"Image"},png:{type:"font-icon",className:"fas fa-file-image",color:"#9b59b6",alt:"Image"},gif:{type:"font-icon",className:"fas fa-file-image",color:"#9b59b6",alt:"Image"},mp4:{type:"font-icon",className:"fas fa-file-video",color:"#e74c3c",alt:"Video"},avi:{type:"font-icon",className:"fas fa-file-video",color:"#e74c3c",alt:"Video"},mp3:{type:"font-icon",className:"fas fa-file-audio",color:"#f39c12",alt:"Audio"},wav:{type:"font-icon",className:"fas fa-file-audio",color:"#f39c12",alt:"Audio"},zip:{type:"font-icon",className:"fas fa-file-archive",color:"#34495e",alt:"Archive"},rar:{type:"font-icon",className:"fas fa-file-archive",color:"#34495e",alt:"Archive"},js:{type:"font-icon",className:"fab fa-js-square",color:"#f1c40f",alt:"JavaScript"},ts:{type:"font-icon",className:"fas fa-code",color:"#3498db",alt:"TypeScript"},html:{type:"font-icon",className:"fab fa-html5",color:"#e74c3c",alt:"HTML"},css:{type:"font-icon",className:"fab fa-css3-alt",color:"#3498db",alt:"CSS"}}[e.toLowerCase()]||{type:"font-icon",className:"fas fa-file",alt:"File"}}extractFileExtension(e){if(!e)return null;const t=e.match(/\.([^.]+)(?:\?|$)/);return t?t[1]:null}sortRulesByPriority(){this.enhancementRules.sort((e,t)=>t.priority-e.priority)}updateStats(e){const t=performance.now()-this.stats.lastResetTime;this.stats.averageEnhancementTime=(this.stats.averageEnhancementTime*(this.stats.totalEnhancements-1)+e)/this.stats.totalEnhancements,this.stats.enhancementsPerSecond=t>0?1e3*this.stats.totalEnhancements/t:0}initializeStats(){return{totalEnhancements:0,successfulEnhancements:0,ruleExecutions:{},averageEnhancementTime:0,enhancementsPerSecond:0,lastResetTime:performance.now()}}getStats(){return{...this.stats}}resetStats(){this.stats=this.initializeStats()}clear(){this.enhancementRules=[],this.categoryMappings.clear(),this.iconMappings.clear(),this.customEnhancers.clear()}getRulesCount(){return this.enhancementRules.length}getMappingsCount(){return{categories:this.categoryMappings.size,icons:this.iconMappings.size,customEnhancers:this.customEnhancers.size}}};class d{constructor(e){this.config={...e},this.validateConfiguration()}transformResults(e,t){if(!Array.isArray(e))return[];const i=performance.now(),s=[];for(let i=0;i<e.length;i++){const r=e[i];if(r?.item)try{const e=this.transformSingleResult(r,t,i);e&&s.push(e)}catch(e){}}const r=performance.now()-i;return s.forEach(e=>{e.metadata&&(e.metadata.queryTime=r)}),s}transformSingleResult(e,t,i){if(!e||!e.item)return null;const s=e.item;if(!s||"object"!=typeof s)return null;const r=this.getFieldValue(s,this.config.labelField);if(!r||"string"!=typeof r&&"number"!=typeof r)return null;const n={score:e.score,matchedFields:e.matchedFields||[],originalIndex:e.originalIndex??i,source:{type:t.sourceType,timestamp:t.timestamp,queryTime:0}};if(this.config.metadataFields)for(const[e,t]of Object.entries(this.config.metadataFields))if(t&&"string"==typeof t){const i=this.getFieldValue(s,t);null!=i&&(n[e]=i)}const a={id:this.generateResultId(s,i),title:String(r),metadata:n},o=this.generateDescription(s,n);o&&(a.description=o);const c=this.extractUrl(s);return c&&(a.url=c),a}generateDescription(e,t){if(t.subtitle&&"string"==typeof t.subtitle)return t.subtitle;const i=["description","subtitle","summary","email","type"];for(const t of i){const i=this.getFieldValue(e,t);if(i&&"string"==typeof i&&i.trim().length>0)return i.trim()}}extractUrl(e){const t=["url","link","href","website"];for(const i of t){const t=this.getFieldValue(e,i);if(t&&"string"==typeof t&&t.trim().length>0)return t.trim()}}generateResultId(e,t){const i=["id","_id","uuid","key"];for(const t of i){const i=this.getFieldValue(e,t);if(null!=i&&("string"==typeof i||"number"==typeof i))return i}return`result_${t}_${Date.now()}`}getFieldValue(e,t){if(!e||"object"!=typeof e)return null;const i=t.split(".");let s=e;for(const e of i){if(!s||"object"!=typeof s||!(e in s))return null;s=s[e]}return s}validateConfiguration(){if(!this.config.labelField)throw new Error("labelField is required in mapping configuration");if("string"!=typeof this.config.labelField)throw new Error("labelField must be a string")}}class m{constructor(e,i){if(this.inputElement=null,this.clearButton=null,this.eventListeners=new Map,this.isInitialized=!1,!(e&&e instanceof HTMLElement))throw new t("Container must be a valid HTMLElement");this.container=e,this.config={...i},this.validateConfig()}init(){this.isInitialized||(this.render(),this.bindEvents(),this.isInitialized=!0)}destroy(){this.isInitialized&&(this.unbindEvents(),this.container.innerHTML="",this.inputElement=null,this.clearButton=null,this.eventListeners.clear(),this.isInitialized=!1)}getValue(){return this.inputElement?.value||""}setValue(e){this.inputElement&&(this.inputElement.value=e||"",this.updateClearButton())}focus(){this.inputElement&&this.inputElement.focus()}blur(){this.inputElement&&this.inputElement.blur()}clear(){this.setValue(""),this.emit("clear"),this.emit("input","")}setLoading(e){this.inputElement&&(e?(this.inputElement.classList.add("loading"),this.inputElement.setAttribute("aria-busy","true")):(this.inputElement.classList.remove("loading"),this.inputElement.removeAttribute("aria-busy")))}setError(e){if(this.inputElement)if(e){this.inputElement.classList.add("error"),this.inputElement.setAttribute("aria-invalid","true"),this.inputElement.setAttribute("aria-describedby","search-error");let t=this.container.querySelector(".search-error");t||(t=document.createElement("div"),t.className="search-error",t.id="search-error",t.setAttribute("role","alert"),this.container.appendChild(t)),t.textContent=e}else{this.inputElement.classList.remove("error"),this.inputElement.removeAttribute("aria-invalid"),this.inputElement.removeAttribute("aria-describedby");const e=this.container.querySelector(".search-error");e&&e.remove()}}on(e,t){this.eventListeners.set(e,t)}off(e){this.eventListeners.delete(e)}render(){const e=document.createElement("div");e.className="search-input-wrapper",this.inputElement=document.createElement("input"),this.inputElement.type="text",this.inputElement.className="search-input",this.inputElement.placeholder=this.config.placeholder||"Search...",this.inputElement.autocomplete="off",this.inputElement.spellcheck=!1,this.inputElement.setAttribute("role","searchbox"),this.inputElement.setAttribute("aria-label","Search"),this.inputElement.setAttribute("aria-autocomplete","list"),this.config.rtl&&(this.inputElement.dir="rtl"),this.clearButton=document.createElement("button"),this.clearButton.type="button",this.clearButton.className="search-clear",this.clearButton.innerHTML="×",this.clearButton.setAttribute("aria-label","Clear search"),this.clearButton.style.display="none",e.appendChild(this.inputElement),e.appendChild(this.clearButton),this.container.appendChild(e),this.updateClearButton()}bindEvents(){this.inputElement&&this.clearButton&&(this.inputElement.addEventListener("input",this.handleInput.bind(this)),this.inputElement.addEventListener("focus",this.handleFocus.bind(this)),this.inputElement.addEventListener("blur",this.handleBlur.bind(this)),this.inputElement.addEventListener("keydown",this.handleKeydown.bind(this)),this.clearButton.addEventListener("click",this.handleClear.bind(this)))}unbindEvents(){this.inputElement&&this.clearButton&&(this.inputElement.removeEventListener("input",this.handleInput.bind(this)),this.inputElement.removeEventListener("focus",this.handleFocus.bind(this)),this.inputElement.removeEventListener("blur",this.handleBlur.bind(this)),this.inputElement.removeEventListener("keydown",this.handleKeydown.bind(this)),this.clearButton.removeEventListener("click",this.handleClear.bind(this)))}handleInput(e){const t=e.target.value;this.updateClearButton(),this.emit("input",t)}handleFocus(e){this.emit("focus",e)}handleBlur(e){this.emit("blur",e)}handleKeydown(e){this.emit("keydown",e)}handleClear(){this.clear(),this.focus()}updateClearButton(){if(this.clearButton){const e=this.getValue().length>0;this.clearButton.style.display=e?"block":"none"}}emit(e,...t){const i=this.eventListeners.get(e);if(i)try{i(...t)}catch(e){}}validateConfig(){if("string"!=typeof this.config.placeholder)throw new t("placeholder must be a string","placeholder");if("boolean"!=typeof this.config.rtl)throw new t("rtl must be a boolean","rtl")}}class p{constructor(e,i){if(this.dropdownElement=null,this.listElement=null,this.results=[],this.selectedIndex=-1,this.eventListeners=new Map,this.isInitialized=!1,this.isVisible=!1,!(e&&e instanceof HTMLElement))throw new t("Container must be a valid HTMLElement");this.container=e,this.config={...i},this.validateConfig()}init(){this.isInitialized||(this.render(),this.bindEvents(),this.isInitialized=!0)}destroy(){this.isInitialized&&(this.unbindEvents(),this.container.innerHTML="",this.dropdownElement=null,this.listElement=null,this.results=[],this.selectedIndex=-1,this.eventListeners.clear(),this.isInitialized=!1,this.isVisible=!1)}showResults(e){if(!Array.isArray(e))throw new t("Results must be an array");this.results=[...e],this.selectedIndex=-1,this.renderResults(),this.show()}clearResults(){this.results=[],this.selectedIndex=-1,this.renderResults(),this.hide()}showLoading(){if(!this.listElement)return;this.listElement.innerHTML="";const e=this.createLoadingItem();this.listElement.appendChild(e),this.show()}showError(e){if(!this.listElement)return;this.listElement.innerHTML="";const t=this.createErrorItem(e);this.listElement.appendChild(t),this.show()}showNoResults(){if(!this.listElement)return;this.listElement.innerHTML="";const e=this.createNoResultsItem();this.listElement.appendChild(e),this.show()}hide(){this.dropdownElement&&(this.dropdownElement.style.display="none",this.dropdownElement.setAttribute("aria-hidden","true"),this.isVisible=!1)}show(){this.dropdownElement&&(this.dropdownElement.style.display="block",this.dropdownElement.setAttribute("aria-hidden","false"),this.isVisible=!0)}navigate(e){if(0===this.results.length)return;let t=this.selectedIndex;switch(e){case"up":t=t<=0?this.results.length-1:t-1;break;case"down":t=t>=this.results.length-1?0:t+1;break;case"first":t=0;break;case"last":t=this.results.length-1}this.setSelectedIndex(t),this.emit("navigate",e)}selectCurrent(){if(this.selectedIndex>=0&&this.selectedIndex<this.results.length){const e=this.results[this.selectedIndex];e&&this.emit("select",e,this.selectedIndex)}}getSelectedResult(){return this.selectedIndex>=0&&this.selectedIndex<this.results.length&&this.results[this.selectedIndex]||null}setSelectedIndex(e){const t=this.selectedIndex;this.selectedIndex=Math.max(-1,Math.min(e,this.results.length-1)),t!==this.selectedIndex&&this.updateSelection()}isOpen(){return this.isVisible}on(e,t){this.eventListeners.set(e,t)}off(e){this.eventListeners.delete(e)}render(){this.dropdownElement=document.createElement("div"),this.dropdownElement.className="search-dropdown",this.dropdownElement.style.display="none",this.dropdownElement.setAttribute("aria-hidden","true"),this.listElement=document.createElement("ul"),this.listElement.className="search-results",this.listElement.setAttribute("role","listbox"),this.listElement.setAttribute("aria-label","Search results"),this.config.rtl&&(this.dropdownElement.dir="rtl"),this.dropdownElement.appendChild(this.listElement),this.container.appendChild(this.dropdownElement)}renderResults(){if(!this.listElement)return;if(this.listElement.innerHTML="",0===this.results.length)return;const e=Math.min(this.results.length,this.config.maxResults);for(let t=0;t<e;t++){const e=this.results[t];if(e){const i=this.createResultItem(e,t);this.listElement.appendChild(i)}}this.updateSelection()}createResultItem(e,t){const i=document.createElement("li");i.className="search-result",i.setAttribute("role","option"),i.setAttribute("data-index",String(t));const s=document.createElement("div");if(s.className="result-title",s.textContent=e.title,i.appendChild(s),e.description){const t=document.createElement("div");t.className="result-description",t.textContent=e.description,i.appendChild(t)}if(e.metadata?.category){const t=document.createElement("div");t.className="result-category",t.textContent=String(e.metadata.category),i.appendChild(t)}return i}createLoadingItem(){const e=document.createElement("li");return e.className="search-loading",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.textContent=this.config.loadingText||"Loading...",e}createErrorItem(e){const t=document.createElement("li");return t.className="search-error",t.setAttribute("role","alert"),t.textContent=e,t}createNoResultsItem(){const e=document.createElement("li");return e.className="search-no-results",e.setAttribute("role","status"),e.textContent=this.config.noResultsText||"No results found",e}updateSelection(){if(!this.listElement)return;this.listElement.querySelectorAll(".search-result").forEach((e,t)=>{t===this.selectedIndex?(e.classList.add("selected"),e.setAttribute("aria-selected","true"),e.scrollIntoView({block:"nearest"})):(e.classList.remove("selected"),e.setAttribute("aria-selected","false"))})}bindEvents(){this.listElement&&(this.listElement.addEventListener("click",this.handleClick.bind(this)),this.listElement.addEventListener("mouseenter",this.handleMouseEnter.bind(this),!0))}unbindEvents(){this.listElement&&(this.listElement.removeEventListener("click",this.handleClick.bind(this)),this.listElement.removeEventListener("mouseenter",this.handleMouseEnter.bind(this),!0))}handleClick(e){const t=e.target.closest(".search-result");if(t){const e=parseInt(t.getAttribute("data-index")||"-1");e>=0&&e<this.results.length&&(this.setSelectedIndex(e),this.selectCurrent())}}handleMouseEnter(e){const t=e.target.closest(".search-result");if(t){const e=parseInt(t.getAttribute("data-index")||"-1");e>=0&&e<this.results.length&&this.setSelectedIndex(e)}}emit(e,...t){const i=this.eventListeners.get(e);if(i)try{i(...t)}catch(e){}}validateConfig(){if("number"!=typeof this.config.maxResults||this.config.maxResults<=0)throw new t("maxResults must be a positive number","maxResults");if("string"!=typeof this.config.loadingText)throw new t("loadingText must be a string","loadingText");if("string"!=typeof this.config.noResultsText)throw new t("noResultsText must be a string","noResultsText");if("boolean"!=typeof this.config.rtl)throw new t("rtl must be a boolean","rtl")}}class f{constructor(){this.frameRateObserver=null,this.interactionObserver=null,this.measurementIdCounter=0,this.enabled=!0,this.measurements=new Map,this.baselines=new Map,this.initializePerformanceObservers(),this.establishDefaultBaselines()}startMeasurement(e,t){if(!this.enabled)return"";const i=`perf_${e}_${++this.measurementIdCounter}_${Date.now()}`,s={id:i,operation:e,startTime:performance.now(),metadata:{...t,userAgent:"undefined"!=typeof navigator?navigator.userAgent:"server",timestamp:Date.now()}};return"undefined"!=typeof performance&&performance.memory&&(s.memoryBefore=performance.memory.usedJSHeapSize),this.measurements.has(e)||this.measurements.set(e,[]),this.measurements.get(e).push(s),i}endMeasurement(e,t=!0,i){const s=performance.now();let r,n="";for(const[t,i]of Array.from(this.measurements.entries())){const s=i.find(t=>t.id===e);if(s){r=s,n=t;break}}if(!r)return{id:e,operation:"unknown",startTime:s,endTime:s,duration:0,success:!1,error:"Measurement not found"};r.endTime=s,r.duration=s-r.startTime,r.success=t,i&&(r.resultCount=i.resultCount,r.cacheStatus=i.cacheStatus,r.sourceLatency=i.sourceLatency,r.frameRate=i.frameRate,r.interactionType=i.interactionType),"undefined"!=typeof performance&&performance.memory&&(r.memoryAfter=performance.memory.usedJSHeapSize);const a=this.measurements.get(n);return a.length>1e3&&a.splice(0,a.length-1e3),this.checkForRegressions(n,r),r}recordInteractionLatency(e,t,i){if(!this.enabled)return;const s={id:`interaction_${++this.measurementIdCounter}_${Date.now()}`,operation:"user_interaction",startTime:performance.now()-t,endTime:performance.now(),duration:t,success:!0,interactionType:e,metadata:{targetElement:i,timestamp:Date.now()}};this.measurements.has("user_interaction")||this.measurements.set("user_interaction",[]),this.measurements.get("user_interaction").push(s)}recordRenderingPerformance(e,t,i){if(!this.enabled)return;const s={id:`render_${++this.measurementIdCounter}_${Date.now()}`,operation:"result_rendering",startTime:performance.now()-e,endTime:performance.now(),duration:e,success:!0,resultCount:t,frameRate:i,metadata:{timestamp:Date.now()}};this.measurements.has("result_rendering")||this.measurements.set("result_rendering",[]),this.measurements.get("result_rendering").push(s)}establishBaseline(e,t,i=16.67,s=100,r=.2){const n={name:e,targetResponseTime:t,targetRenderTime:i,targetInteractionLatency:s,regressionThreshold:r,establishedDate:Date.now(),sampleSize:100};this.baselines.set(e,n)}detectRegressions(e){const t=(this.measurements.get(e)||[]).slice(-50);if(t.length<10)return{detected:!1,affectedMetrics:[],severity:"minor",comparison:[],recommendations:[],timestamp:Date.now()};const i=this.baselines.get("default");if(!i)return{detected:!1,affectedMetrics:[],severity:"minor",comparison:[],recommendations:[],timestamp:Date.now()};const s=t.filter(e=>void 0!==e.duration).reduce((e,t)=>e+t.duration,0)/t.length,r=t.filter(e=>void 0!==e.frameRate).reduce((e,t)=>e+16.67/(t.frameRate/60),0)/t.length,n=[],a=[];let o=0;if(s>i.targetResponseTime*(1+i.regressionThreshold)){const e=(s-i.targetResponseTime)/i.targetResponseTime;n.push({metric:"response_time",current:s,baseline:i.targetResponseTime,degradation:e}),a.push("response_time"),o=Math.max(o,e)}if(r>i.targetRenderTime*(1+i.regressionThreshold)){const e=(r-i.targetRenderTime)/i.targetRenderTime;n.push({metric:"render_time",current:r,baseline:i.targetRenderTime,degradation:e}),a.push("render_time"),o=Math.max(o,e)}let c="minor";o>.5?c="severe":o>.3&&(c="moderate");const l=this.generateRegressionRecommendations(a,c);return{detected:a.length>0,affectedMetrics:a,severity:c,comparison:n,recommendations:l,timestamp:Date.now()}}getMetricsSummary(e,t){const i=t?Date.now()-t:0;let s=[];if(e)s=(this.measurements.get(e)||[]).filter(e=>e.startTime>=i);else for(const e of Array.from(this.measurements.values()))s.push(...e.filter(e=>e.startTime>=i));const r=s.filter(e=>void 0!==e.duration).map(e=>e.duration).sort((e,t)=>e-t),n=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0,a=s.filter(e=>void 0!==e.frameRate),o=a.length>0?a.reduce((e,t)=>e+16.67/(t.frameRate/60),0)/a.length:0,c=a.length>0?a.reduce((e,t)=>e+t.frameRate,0)/a.length:60,l=s.filter(e=>void 0!==e.interactionType),u={};for(const e of l){const t=e.interactionType;u[t]||(u[t]=[]),void 0!==e.duration&&u[t].push(e.duration)}const h=l.length>0?l.reduce((e,t)=>e+(t.duration||0),0)/l.length:0,d={};for(const[e,t]of Object.entries(u))d[e]=t.reduce((e,t)=>e+t,0)/t.length;const m=s.filter(e=>void 0!==e.cacheStatus),p=m.filter(e=>"hit"===e.cacheStatus),f=m.filter(e=>"miss"===e.cacheStatus),g=m.length>0?p.length/m.length:0,y=p.length>0?p.reduce((e,t)=>e+(t.duration||0),0)/p.length:0,w=f.length>0?f.reduce((e,t)=>e+(t.duration||0),0)/f.length:0,b=[];if(e)b.push(this.detectRegressions(e));else for(const e of Array.from(this.measurements.keys()))b.push(this.detectRegressions(e));return{responseTime:{avg:n,p95:this.getPercentile(r,.95),p99:this.getPercentile(r,.99)},renderTime:{avg:o,targetFps:c},interactionLatency:{avg:h,byType:d},cachePerformance:{hitRate:g,avgHitTime:y,avgMissTime:w},regressions:b.filter(e=>e.detected)}}setEnabled(e){this.enabled=e,e?this.initializePerformanceObservers():this.cleanup()}clearMeasurements(e){e?this.measurements.delete(e):this.measurements.clear()}getMeasurements(e){return[...this.measurements.get(e)||[]]}cleanup(){this.frameRateObserver&&(this.frameRateObserver.disconnect(),this.frameRateObserver=null),this.interactionObserver&&(this.interactionObserver.disconnect(),this.interactionObserver=null)}initializePerformanceObservers(){if("undefined"!=typeof PerformanceObserver)try{this.frameRateObserver=new PerformanceObserver(e=>{for(const t of e.getEntries())if("measure"===t.entryType||"paint"===t.entryType){const e=t.duration||t.startTime,i=e>0?1e3/e:60;i<55&&this.recordRenderingPerformance(e,0,i)}}),this.frameRateObserver.observe({entryTypes:["measure","paint"]}),this.interactionObserver=new PerformanceObserver(e=>{for(const t of e.getEntries())if("event"===t.entryType){const e=t,i=e.processingEnd-e.startTime;let s="click";e.name.includes("key")?s="keyboard":e.name.includes("touch")&&(s="touch"),this.recordInteractionLatency(s,i,e.target?.toString())}}),"PerformanceEventTiming"in window&&this.interactionObserver.observe({entryTypes:["event"]})}catch(e){}}establishDefaultBaselines(){this.establishBaseline("default",200,16.67,100,.2),this.establishBaseline("search_query",150,16.67,50,.15),this.establishBaseline("result_rendering",50,16.67,30,.1),this.establishBaseline("user_interaction",16,16.67,100,.25)}checkForRegressions(e,t){if(this.measurementIdCounter%10!=0)return;const i=this.detectRegressions(e);i.detected&&"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("performance-regression",{detail:{operation:e,regression:i,measurement:t}}))}generateRegressionRecommendations(e,t){const i=[];return e.includes("response_time")&&(i.push("Consider implementing or improving result caching"),i.push("Review data source query optimization"),"severe"===t&&i.push("Implement request debouncing or throttling")),e.includes("render_time")&&(i.push("Optimize result rendering with virtual scrolling"),i.push("Reduce DOM manipulations during rendering"),"severe"===t&&i.push("Consider implementing progressive rendering")),e.includes("interaction_latency")&&(i.push("Optimize event handlers and reduce processing time"),i.push("Implement event delegation for better performance")),i}getPercentile(e,t){if(0===e.length)return 0;const i=Math.ceil(e.length*t)-1;return e[Math.max(0,Math.min(i,e.length-1))]}}new f;const g={enabled:!0,sampleRate:1,sessionTimeout:30,bufferSize:100,flushInterval:30,privacyMode:"balanced",collectSearchTerms:!0,anonymizeIPs:!0,retentionPeriod:90};class y{constructor(e={}){this.currentSession=null,this.flushTimer=null,this.eventHandlers=[],this.sessionCounter=0,this.eventCounter=0,this.metricsCache=null,this.metricsCacheTimestamp=0,this.CACHE_DURATION=6e4,this.config={...g,...e},this.eventBuffer=[],this.sessions=new Map,this.initialize()}trackEvent(e,t={},i){if(!this.config.enabled||Math.random()>this.config.sampleRate)return;const s=this.getCurrentSession(),r=`event_${++this.eventCounter}_${Date.now()}`,n={consent:this.hasUserConsent(),anonymized:"strict"===this.config.privacyMode||this.shouldAnonymize(e),region:this.getUserRegion()},a={id:r,type:e,timestamp:Date.now(),sessionId:s.id,userAgent:"undefined"!=typeof navigator?navigator.userAgent:void 0,properties:this.sanitizeProperties(t,n.anonymized),context:{url:"undefined"!=typeof location?location.href:void 0,referrer:"undefined"!=typeof document?document.referrer:void 0,viewport:this.getViewportSize(),deviceType:this.getDeviceType(),...i},privacy:n};this.eventBuffer.push(a),this.updateSession(s,a),this.eventBuffer.length>=this.config.bufferSize&&this.flush()}trackSearchInitiated(e,t){this.trackEvent("search_initiated",{query:this.config.collectSearchTerms?e:"[REDACTED]",queryLength:e.length,hasFilters:Boolean(t&&Object.keys(t).length>0),filterCount:t?Object.keys(t).length:0,filters:"strict"!==this.config.privacyMode?t:void 0})}trackSearchCompleted(e,t,i,s){this.trackEvent("search_completed",{query:this.config.collectSearchTerms?e:"[REDACTED]",queryLength:e.length,resultCount:t,responseTime:i,dataSource:s,hasResults:t>0})}trackResultSelection(e,t,i,s){this.trackEvent("result_selected",{query:this.config.collectSearchTerms?e:"[REDACTED]",queryLength:e.length,resultPosition:t,resultId:i||"[ANONYMOUS]",resultType:s,isFirstResult:0===t})}trackError(e,t,i,s){this.trackEvent("error_occurred",{errorType:e,errorMessage:this.sanitizeErrorMessage(t),query:i&&this.config.collectSearchTerms?i:"[REDACTED]",queryLength:i?i.length:0,timestamp:Date.now(),...s})}trackFeatureUsage(e,t){this.trackEvent("feature_used",{feature:e,...t})}getMetrics(e){const t=Date.now();if(this.metricsCache&&t-this.metricsCacheTimestamp<this.CACHE_DURATION)return this.metricsCache;const i=e?t-e:t-864e5,s=this.eventBuffer.filter(e=>e.timestamp>=i),r=Array.from(this.sessions.values()).filter(e=>e.startTime>=i),n=this.calculateMetrics(s,r,i,t);return this.metricsCache=n,this.metricsCacheTimestamp=t,n}analyzeFunnel(e="default"){const t=[{name:"Search Initiated",eventType:"search_initiated"},{name:"Search Completed",eventType:"search_completed"},{name:"Result Viewed",eventType:"result_viewed"},{name:"Result Selected",eventType:"result_selected"}],i=Array.from(this.sessions.values()),s=new Map,r=new Map,n=i.length;for(const e of i){const i=[...e.searchEvents,...e.selectionEvents,...e.errorEvents].sort((e,t)=>e.timestamp-t.timestamp),n=new Set;for(const a of i)if(!n.has(a.type)&&t.some(e=>e.eventType===a.type)){s.set(a.type,(s.get(a.type)||0)+1),n.add(a.type);const t=a.timestamp-e.startTime;r.has(a.type)||r.set(a.type,[]),r.get(a.type).push(t)}}const a=t.map((e,i)=>{const a=s.get(e.eventType)||0,o=0===i?n:s.get(t[i-1].eventType)||0,c=o>0?a/o:0,l=1-c,u=r.get(e.eventType)||[],h=u.length>0?u.reduce((e,t)=>e+t,0)/u.length:0;return{name:e.name,eventType:e.eventType,count:a,conversionRate:c,dropoffRate:l,averageTime:h}}),o=a[0]?.count||0,c=a[a.length-1]?.count||0,l=o>0?c/o:0,u=n>0?c/n:0,h=a.filter(e=>e.dropoffRate>.3).map(e=>({step:e.name,dropoffRate:e.dropoffRate,severity:e.dropoffRate>.6?"high":e.dropoffRate>.4?"medium":"low"}));return{name:e,steps:a,overallConversionRate:l,totalUsers:n,completionRate:u,bottlenecks:h}}onEvent(e){this.eventHandlers.push(e)}flush(){if(0===this.eventBuffer.length)return;const e=[...this.eventBuffer];this.eventBuffer=[];for(const t of this.eventHandlers)try{t(e)}catch(e){}}clear(){this.eventBuffer=[],this.sessions.clear(),this.currentSession=null,this.metricsCache=null,this.metricsCacheTimestamp=0}destroy(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.flush(),this.clear()}initialize(){this.config.enabled&&(this.flushTimer=setInterval(()=>{this.flush()},1e3*this.config.flushInterval),this.startSession(),setInterval(()=>{this.cleanupOldSessions()},3e5))}getCurrentSession(){return this.currentSession&&!this.isSessionExpired(this.currentSession)||this.startSession(),this.currentSession.lastActivity=Date.now(),this.currentSession}startSession(){const e=`session_${++this.sessionCounter}_${Date.now()}`,t=Date.now();this.currentSession&&!this.currentSession.ended&&this.endSession(this.currentSession),this.currentSession={id:e,startTime:t,lastActivity:t,duration:0,searchEvents:[],selectionEvents:[],errorEvents:[],totalSearches:0,totalSelections:0,totalErrors:0,ended:!1},this.sessions.set(e,this.currentSession),this.trackEvent("session_started")}endSession(e){if(e.ended)return;e.ended=!0,e.duration=e.lastActivity-e.startTime;const t=this.currentSession;this.currentSession=e,this.trackEvent("session_ended",{sessionDuration:e.duration,totalSearches:e.totalSearches,totalSelections:e.totalSelections,totalErrors:e.totalErrors,selectionRate:e.totalSearches>0?e.totalSelections/e.totalSearches:0}),this.currentSession=t}updateSession(e,t){switch(e.lastActivity=t.timestamp,t.type){case"search_initiated":case"search_completed":e.searchEvents.push(t),"search_initiated"===t.type&&e.totalSearches++;break;case"result_selected":e.selectionEvents.push(t),e.totalSelections++;break;case"error_occurred":e.errorEvents.push(t),e.totalErrors++}}isSessionExpired(e){return Date.now()-e.lastActivity>60*this.config.sessionTimeout*1e3}cleanupOldSessions(){const e=Date.now()-60*this.config.sessionTimeout*1e3;for(const[t,i]of Array.from(this.sessions.entries()))i.lastActivity<e&&!i.ended&&this.endSession(i),i.startTime<Date.now()-24*this.config.retentionPeriod*60*60*1e3&&this.sessions.delete(t)}calculateMetrics(e,t,i,s){const r=new Map;for(const t of e)r.has(t.type)||r.set(t.type,[]),r.get(t.type).push(t);const n=r.get("search_initiated")||[],a=r.get("search_completed")||[],o=r.get("result_selected")||[],c=r.get("error_occurred")||[],l=n.length,u=t.length>0?l/t.length:0,h={};for(const e of n){const t=new Date(e.timestamp).getHours().toString();h[t]=(h[t]||0)+1}const d=Math.max(...Object.values(h),0),m={};for(const e of n){const t=e.properties.query;t&&"string"==typeof t&&"[REDACTED]"!==t&&(m[t]=(m[t]||0)+1)}const p=Object.entries(m).sort(([,e],[,t])=>t-e).slice(0,10).map(([e,t])=>({term:e,count:t,anonymized:"strict"===this.config.privacyMode})),f=o.length,g=l>0?f/l:0,y=o.map(e=>e.properties.resultPosition).filter(e=>"number"==typeof e),w=y.length>0?y.reduce((e,t)=>e+t,0)/y.length:0,b={};for(const e of y){const t=e.toString();b[t]=(b[t]||0)+1}const v=a.filter(e=>0===e.properties.resultCount).length,C=c.length,T=l>0?C/l:0,E={},S={};for(const e of c){const t=e.properties.errorType||"unknown",i=e.properties.dataSource||"unknown";E[t]=(E[t]||0)+1,S[i]=(S[i]||0)+1}let R=0;for(const e of t){const t=[...e.searchEvents,...e.errorEvents].sort((e,t)=>e.timestamp-t.timestamp);for(let e=0;e<t.length-1;e++)"error_occurred"===t[e].type&&"search_completed"===t[e+1].type&&R++}const x=C>0?R/C:0,k=t.length,M=t.map(e=>e.ended?e.duration:Date.now()-e.startTime),A=M.length>0?M.reduce((e,t)=>e+t,0)/M.length:0,I=t.filter(e=>1===e.totalSearches).length,q=k>0?I/k:0,P=r.get("feature_used")||[],L={};for(const e of P){const t=e.properties.feature;t&&(L[t]=(L[t]||0)+1)}return{period:{start:i,end:s,duration:s-i},searchFrequency:{total:l,averagePerSession:u,peakPerHour:d,hourlyPattern:h,popularTerms:p},resultSelection:{total:f,selectionRate:g,averagePosition:w,positionDistribution:b,zeroResultQueries:v},errorPatterns:{total:C,errorRate:T,byType:E,bySource:S,recoveryRate:x},engagement:{totalSessions:k,averageSessionDuration:A,bounceRate:q,returnUserRate:0,featureUsage:L},performanceCorrelation:{responseTimeCorrelation:this.calculateCorrelation(a.map(e=>e.properties.responseTime).filter(e=>"number"==typeof e),o.map((e,t)=>t<a.length?1:0)),errorAbandonmentCorrelation:0,loadTimeImpact:0}}}calculateCorrelation(e,t){if(e.length!==t.length||0===e.length)return 0;const i=e.reduce((e,t)=>e+t,0)/e.length,s=t.reduce((e,t)=>e+t,0)/t.length;let r=0,n=0,a=0;for(let o=0;o<e.length;o++)r+=(e[o]-i)*(t[o]-s),n+=(e[o]-i)**2,a+=(t[o]-s)**2;const o=Math.sqrt(n*a);return 0!==o?r/o:0}sanitizeProperties(e,t){if(!t)return e;const i={};for(const[t,s]of Object.entries(e))"query"===t||"resultId"===t?i[t]="[REDACTED]":"string"==typeof s&&s.length>100?i[t]="[TRUNCATED]":i[t]=s;return i}sanitizeErrorMessage(e){return e.replace(/\b\d{4}-\d{2}-\d{2}\b/g,"[DATE]").replace(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g,"[IP]").replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,"[EMAIL]")}hasUserConsent(){return"undefined"!=typeof localStorage?"true"===localStorage.getItem("analytics-consent"):"strict"!==this.config.privacyMode}shouldAnonymize(e){return"strict"===this.config.privacyMode||["search_initiated","search_completed","error_occurred"].includes(e)}getUserRegion(){if("undefined"!=typeof navigator&&navigator.language)return navigator.language.split("-")[1]||"US"}getViewportSize(){if("undefined"!=typeof window)return{width:window.innerWidth,height:window.innerHeight}}getDeviceType(){if("undefined"==typeof window)return;const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}}new y;class w{constructor(){this.profiles=new Map,this.currentProfile=null,this.compatibilityMatrix=null,this.measurements=[],this.performanceBaselines=new Map,this.initialize()}getCurrentProfile(){return this.currentProfile||(this.currentProfile=this.createBrowserProfile()),this.currentProfile}recordPerformanceMeasurement(e,t,i,s){const r=this.getCurrentProfile();this.measurements.push({timestamp:Date.now(),responseTime:e,renderTime:t||0,interactionLatency:i||0,memoryUsage:s||0,browserId:r.id}),this.updateProfilePerformance(r),this.measurements.length>1e3&&(this.measurements=this.measurements.slice(-1e3))}getPerformanceComparison(){const e={},t=Array.from(this.profiles.values()),i=this.calculateAveragePerformance(t);for(const s of t){const t=this.calculateRelativePerformance(s.performance,i);e[s.id]={browser:`${s.browser.name} ${s.browser.version}`,version:s.browser.version,performance:s.performance,relativePerformance:t}}return e}generateRecommendations(e){const t=e?this.profiles.get(e):this.getCurrentProfile();if(!t)return[];const i=[],s=t.browser,r=t.capabilities,n=t.performance;return n.averageResponseTime>200&&(s.name.toLowerCase().includes("chrome")?i.push({target:t.id,type:"optimization",title:"Enable HTTP/2 Push for Chrome",description:"Chrome supports HTTP/2 server push for faster resource loading",implementation:"Configure server with HTTP/2 push headers for critical resources",impact:{performanceGain:.3,compatibilityImprovement:0},priority:"high",effort:"medium"}):s.name.toLowerCase().includes("firefox")&&i.push({target:t.id,type:"optimization",title:"Optimize for Firefox Network Stack",description:"Firefox benefits from connection pooling optimizations",implementation:"Use connection: keep-alive and optimize request batching",impact:{performanceGain:.2,compatibilityImprovement:0},priority:"medium",effort:"low"})),n.averageRenderTime>16.67&&(!r.features.webGL&&r.features.webGL2&&i.push({target:t.id,type:"feature-toggle",title:"Use WebGL2 for Better Rendering",description:"Browser supports WebGL2 which can improve rendering performance",implementation:"Enable WebGL2 rendering path when available",impact:{performanceGain:.4,compatibilityImprovement:.1},priority:"high",effort:"medium"}),"mobile"===s.deviceType&&i.push({target:t.id,type:"optimization",title:"Optimize for Mobile Rendering",description:"Mobile devices benefit from reduced DOM manipulation",implementation:"Use requestAnimationFrame and batch DOM updates",impact:{performanceGain:.3,compatibilityImprovement:0},priority:"high",effort:"low"})),r.memory&&r.memory.total&&r.memory.total<2e3&&i.push({target:t.id,type:"optimization",title:"Low Memory Device Optimization",description:"Device has limited memory, implement aggressive cleanup",implementation:"Enable frequent garbage collection and limit cache size",impact:{performanceGain:.2,compatibilityImprovement:.3},priority:"high",effort:"medium"}),r.features.intersectionObserver||i.push({target:t.id,type:"polyfill",title:"Add Intersection Observer Polyfill",description:"Browser lacks Intersection Observer support for efficient scrolling",implementation:"Include intersection-observer polyfill for scroll performance",impact:{performanceGain:.1,compatibilityImprovement:.8},priority:"medium",effort:"low"}),"2g"!==r.connection?.effectiveType&&"3g"!==r.connection?.effectiveType||i.push({target:t.id,type:"optimization",title:"Slow Network Optimization",description:"Device is on slow network, implement aggressive caching",implementation:"Enable service worker caching and reduce payload sizes",impact:{performanceGain:.5,compatibilityImprovement:0},priority:"high",effort:"high"}),i.sort((e,t)=>{const i={high:3,medium:2,low:1};return i[t.priority]-i[e.priority]})}getCompatibilityMatrix(){return this.compatibilityMatrix||(this.compatibilityMatrix=this.buildCompatibilityMatrix()),this.compatibilityMatrix}getBrowserCompatibilityScore(e){const t=e?this.profiles.get(e):this.getCurrentProfile();if(!t)return{score:0,supportedFeatures:[],unsupportedFeatures:[],recommendations:["Browser profile not available"]};const i=t.capabilities,s=["localStorage","performanceObserver","webWorkers","intersectionObserver"],r=["serviceWorker","webAssembly","webGL","requestIdleCallback","mutationObserver"],n=[],a=[];for(const e of s){this.isFeatureSupported(i,e)?n.push(e):a.push(e)}for(const e of r){this.isFeatureSupported(i,e)?n.push(e):a.push(e)}s.length,r.length;const o=n.filter(e=>s.includes(e)).length/s.length*70,c=n.filter(e=>r.includes(e)).length/r.length*30;return{score:Math.round(o+c),supportedFeatures:n,unsupportedFeatures:a,recommendations:this.generateCompatibilityRecommendations(a,t)}}trackViewportChange(e,t){const i=this.getCurrentProfile();i.capabilities.viewport={width:e,height:t},i.capabilities.screen.orientation=e>t?"landscape":"portrait",i.lastUpdated=Date.now()}clearProfiles(){this.profiles.clear(),this.currentProfile=null,this.measurements=[],this.compatibilityMatrix=null}initialize(){this.currentProfile=this.createBrowserProfile(),this.profiles.set(this.currentProfile.id,this.currentProfile),"undefined"!=typeof window&&(window.addEventListener("resize",()=>{this.trackViewportChange(window.innerWidth,window.innerHeight)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.trackViewportChange(window.innerWidth,window.innerHeight)},100)})),this.establishBaselines()}createBrowserProfile(){const e=this.detectBrowser(),t=this.detectCapabilities();return{id:this.generateBrowserId(e,t),browser:e,capabilities:t,performance:{averageResponseTime:0,averageRenderTime:16.67,averageInteractionLatency:0,frameRate:60,memoryEfficiency:1,cacheHitRate:0},performanceScore:50,compatibilityScore:this.calculateCompatibilityScore(t),sampleSize:0,lastUpdated:Date.now(),trends:{improving:0,degrading:0,stable:1}}}detectBrowser(){const e="undefined"!=typeof navigator?navigator.userAgent:"",t="undefined"!=typeof navigator?navigator.platform:"";let i="Unknown",s="0",r="Unknown";if(e.includes("Chrome")&&!e.includes("Edg")){i="Chrome";const t=e.match(/Chrome\/([^\s]+)/);s=t?t[1]:"0",r="Blink"}else if(e.includes("Firefox")){i="Firefox";const t=e.match(/Firefox\/([^\s]+)/);s=t?t[1]:"0",r="Gecko"}else if(e.includes("Safari")&&!e.includes("Chrome")){i="Safari";const t=e.match(/Version\/([^\s]+)/);s=t?t[1]:"0",r="WebKit"}else if(e.includes("Edg")){i="Edge";const t=e.match(/Edg\/([^\s]+)/);s=t?t[1]:"0",r="Blink"}let n="Unknown";t.includes("Win")?n="Windows":t.includes("Mac")?n="macOS":t.includes("Linux")?n="Linux":e.includes("Android")?n="Android":(e.includes("iPhone")||e.includes("iPad"))&&(n="iOS");const a=/Mobi|Android/i.test(e);let o="desktop";/iPad|Tablet/i.test(e)?o="tablet":a&&(o="mobile");return{name:i,version:s,engine:r,engineVersion:"0",os:n,osVersion:"0",deviceType:o,isMobile:a,isTouch:"undefined"!=typeof navigator&&"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0,userAgent:e}}detectCapabilities(){const e={screen:{width:"undefined"!=typeof screen?screen.width:1920,height:"undefined"!=typeof screen?screen.height:1080,pixelRatio:"undefined"!=typeof window&&window.devicePixelRatio||1,colorDepth:"undefined"!=typeof screen?screen.colorDepth:24,orientation:"undefined"!=typeof window&&window.innerWidth>window.innerHeight?"landscape":"portrait"},viewport:{width:"undefined"!=typeof window?window.innerWidth:1920,height:"undefined"!=typeof window?window.innerHeight:1080},storage:{localStorage:"undefined"!=typeof localStorage,sessionStorage:"undefined"!=typeof sessionStorage,indexedDB:"undefined"!=typeof indexedDB,webSQL:void 0!==window.openDatabase},features:{webGL:this.detectWebGL(),webGL2:this.detectWebGL2(),serviceWorker:"serviceWorker"in navigator,webAssembly:"undefined"!=typeof WebAssembly,performanceObserver:"undefined"!=typeof PerformanceObserver,intersectionObserver:"undefined"!=typeof IntersectionObserver,mutationObserver:"undefined"!=typeof MutationObserver,requestIdleCallback:"undefined"!=typeof requestIdleCallback,webWorkers:"undefined"!=typeof Worker,sharedArrayBuffer:"undefined"!=typeof SharedArrayBuffer}};if("undefined"!=typeof performance&&performance.memory){const t=performance.memory;e.memory={total:t.totalJSHeapSize,used:t.usedJSHeapSize,limit:t.jsHeapSizeLimit}}if("undefined"!=typeof navigator&&navigator.connection){const t=navigator.connection;e.connection={effectiveType:t.effectiveType,downlink:t.downlink,rtt:t.rtt,saveData:t.saveData}}return"undefined"!=typeof navigator&&"hardwareConcurrency"in navigator&&(e.cpu={cores:navigator.hardwareConcurrency}),e}detectWebGL(){try{const e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}detectWebGL2(){try{return!!document.createElement("canvas").getContext("webgl2")}catch(e){return!1}}generateBrowserId(e,t){return[e.name.toLowerCase(),e.version.split(".")[0],e.deviceType,e.os.toLowerCase(),t.screen.width+"x"+t.screen.height].join("_")}updateProfilePerformance(e){const t=this.measurements.filter(t=>t.browserId===e.id).slice(-100);if(0===t.length)return;const i=t.reduce((e,t)=>e+t.responseTime,0)/t.length,s=t.reduce((e,t)=>e+t.renderTime,0)/t.length,r=t.reduce((e,t)=>e+t.interactionLatency,0)/t.length;e.performance.averageResponseTime=i,e.performance.averageRenderTime=s,e.performance.averageInteractionLatency=r,e.performance.frameRate=s>0?1e3/s:60,e.sampleSize=t.length,e.lastUpdated=Date.now(),e.performanceScore=this.calculatePerformanceScore(e.performance)}calculatePerformanceScore(e){let t=100;return e.averageResponseTime>100&&(t-=Math.min(30,(e.averageResponseTime-100)/10)),e.averageRenderTime>16.67&&(t-=Math.min(25,2*(e.averageRenderTime-16.67))),e.averageInteractionLatency>50&&(t-=Math.min(25,(e.averageInteractionLatency-50)/4)),e.frameRate<60&&(t-=Math.min(20,(60-e.frameRate)/3)),Math.max(0,Math.round(t))}calculateCompatibilityScore(e){const t=["localStorage","performanceObserver"],i=["serviceWorker","webAssembly","webGL","intersectionObserver"];let s=0;for(const i of t){const t=35;this.isFeatureSupported(e,i)&&(s+=t)}for(const t of i){const i=7.5;this.isFeatureSupported(e,t)&&(s+=i)}return Math.round(s)}isFeatureSupported(e,t){switch(t){case"localStorage":return e.storage.localStorage;case"serviceWorker":return e.features.serviceWorker;case"webAssembly":return e.features.webAssembly;case"webGL":return e.features.webGL;case"performanceObserver":return e.features.performanceObserver;case"intersectionObserver":return e.features.intersectionObserver;case"requestIdleCallback":return e.features.requestIdleCallback;case"webWorkers":return e.features.webWorkers;default:return!1}}calculateAveragePerformance(e){if(0===e.length)return{averageResponseTime:0,averageRenderTime:16.67,averageInteractionLatency:0,frameRate:60,memoryEfficiency:1,cacheHitRate:0};const t=e.reduce((e,t)=>({averageResponseTime:e.averageResponseTime+t.performance.averageResponseTime,averageRenderTime:e.averageRenderTime+t.performance.averageRenderTime,averageInteractionLatency:e.averageInteractionLatency+t.performance.averageInteractionLatency,frameRate:e.frameRate+t.performance.frameRate,memoryEfficiency:e.memoryEfficiency+t.performance.memoryEfficiency,cacheHitRate:e.cacheHitRate+t.performance.cacheHitRate}),{averageResponseTime:0,averageRenderTime:0,averageInteractionLatency:0,frameRate:0,memoryEfficiency:0,cacheHitRate:0}),i=e.length;return{averageResponseTime:t.averageResponseTime/i,averageRenderTime:t.averageRenderTime/i,averageInteractionLatency:t.averageInteractionLatency/i,frameRate:t.frameRate/i,memoryEfficiency:t.memoryEfficiency/i,cacheHitRate:t.cacheHitRate/i}}calculateRelativePerformance(e,t){return.3*(t.averageResponseTime>0?t.averageResponseTime/e.averageResponseTime:1)+.25*(t.averageRenderTime>0?t.averageRenderTime/e.averageRenderTime:1)+.25*(t.averageInteractionLatency>0?t.averageInteractionLatency/e.averageInteractionLatency:1)+.2*(t.frameRate>0?e.frameRate/t.frameRate:1)}buildCompatibilityMatrix(){const e={},t={},i={};for(const s of Array.from(this.profiles.values())){const r=`${s.browser.name}_${s.browser.version.split(".")[0]}`;e[r]={webGL:s.capabilities.features.webGL,webGL2:s.capabilities.features.webGL2,serviceWorker:s.capabilities.features.serviceWorker,webAssembly:s.capabilities.features.webAssembly,performanceObserver:s.capabilities.features.performanceObserver,intersectionObserver:s.capabilities.features.intersectionObserver,requestIdleCallback:s.capabilities.features.requestIdleCallback},t[r]={responseTime:s.performance.averageResponseTime,renderTime:s.performance.averageRenderTime,interactionLatency:s.performance.averageInteractionLatency,score:s.performanceScore},i[r]=this.generateOptimizationList(s)}return{features:e,benchmarks:t,optimizations:i,knownIssues:{}}}generateOptimizationList(e){const t=[],i=e.browser.name.toLowerCase();return i.includes("chrome")?(t.push("Use requestAnimationFrame for smooth animations"),t.push("Enable HTTP/2 server push"),t.push("Use intersection observer for lazy loading")):i.includes("firefox")?(t.push("Optimize for Firefox connection pooling"),t.push("Use will-change CSS property sparingly")):i.includes("safari")&&(t.push("Avoid transform3d for better compatibility"),t.push("Use -webkit- prefixes for newer features")),"mobile"===e.browser.deviceType&&(t.push("Implement touch gesture optimization"),t.push("Use passive event listeners"),t.push("Minimize DOM manipulation frequency")),t}generateCompatibilityRecommendations(e,t){const i=[];for(const t of e)switch(t){case"serviceWorker":i.push("Consider using AppCache as fallback for offline support");break;case"intersectionObserver":i.push("Use intersection-observer polyfill for scroll performance");break;case"requestIdleCallback":i.push("Use setTimeout as fallback for idle scheduling");break;case"webGL":i.push("Provide canvas 2D fallback for graphics rendering");break;case"performanceObserver":i.push("Use performance.now() for basic timing measurements")}return i}establishBaselines(){this.performanceBaselines.set("desktop_chrome",150),this.performanceBaselines.set("desktop_firefox",180),this.performanceBaselines.set("desktop_safari",200),this.performanceBaselines.set("mobile_chrome",250),this.performanceBaselines.set("mobile_safari",300),this.performanceBaselines.set("mobile_firefox",280)}}new w;class b{constructor(){this.experiments=new Map,this.participants=new Map,this.events=[],this.assignmentCache=new Map,this.results=new Map,this.eventHandlers=[],this.setupCleanupSchedule()}createExperiment(e){this.validateExperimentConfig(e),this.experiments.set(e.id,e);const t={experimentId:e.id,variations:{},statistics:{tests:{},overallSignificance:!1,multipleComparisons:{method:"benjamini-hochberg",adjustedPValues:{}},power:{observedPower:0,requiredSampleSize:e.duration.minSampleSize,actualSampleSize:0}},sampleSize:{total:0,byVariation:{},isSignificant:!1},analyzedAt:Date.now()};for(const i of e.variations)t.variations[i.id]={variationId:i.id,sampleSize:0,metrics:{}},t.sampleSize.byVariation[i.id]=0;this.results.set(e.id,t)}assignParticipant(e,t,i={}){const s=this.experiments.get(e);if(!s||"active"!==s.status)return null;const r=`${t}_${e}`,n=this.assignmentCache.get(r);if(n)return n;if(!this.meetsExperimentCriteria(s,i))return null;const a=this.selectVariation(s,t);if(!a)return null;const o={id:t,experimentId:e,variationId:a,assignedAt:Date.now(),metadata:i,events:[]};this.participants.set(`${t}_${e}`,o),this.assignmentCache.set(r,a);const c=this.results.get(e);return c.sampleSize.total++,c.sampleSize.byVariation[a]++,c.variations[a].sampleSize++,a}trackEvent(e,t,i,s,r={}){const n=this.experiments.get(e);if(!n||"active"!==n.status)return;const a=`${t}_${e}`,o=this.participants.get(a);if(!o)return;const c={id:`event_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,participantId:t,experimentId:e,variationId:o.variationId,metricId:i,value:s,timestamp:Date.now(),metadata:r};this.events.push(c),o.events.push(c),this.events.length>1e4&&(this.events=this.events.slice(-1e4));for(const e of this.eventHandlers)try{e(c)}catch(e){}this.scheduleResultsUpdate(e)}getExperimentConfig(e,t){const i=`${t}_${e}`,s=this.participants.get(i);if(!s)return null;const r=this.experiments.get(e);if(!r)return null;const n=r.variations.find(e=>e.id===s.variationId);return n?.config||null}analyzeExperiment(e){const t=this.experiments.get(e);if(!t)return null;const i=this.calculateExperimentResults(t);return this.results.set(e,i),i}getRecommendations(e){const t=this.experiments.get(e),i=this.results.get(e);if(!t||!i)return[];const s=[],r=Date.now();if(i.statistics.overallSignificance&&i.winner&&s.push({type:"stop",title:"Stop Experiment Early - Significant Results",explanation:`Experiment has reached statistical significance with ${(100*i.winner.confidence).toFixed(1)}% confidence. The winning variation (${i.winner.variationId}) shows a ${(100*i.winner.lift).toFixed(1)}% improvement.`,confidence:i.winner.confidence,actions:[`Deploy winning variation: ${i.winner.variationId}`,"Document experiment results","Plan rollout strategy"],risks:[{description:"Early stopping may miss long-term effects",probability:.2,impact:"medium"}]}),i.sampleSize.total<t.duration.minSampleSize){const e=t.duration.endTime-r,n=i.sampleSize.total/((r-t.duration.startTime)/864e5),a=(t.duration.minSampleSize-i.sampleSize.total)/n;a>e/864e5&&s.push({type:"extend",title:"Extend Experiment Duration",explanation:`Current sample size (${i.sampleSize.total}) is below minimum required (${t.duration.minSampleSize}). Estimated ${a.toFixed(1)} more days needed.`,confidence:.8,actions:["Extend experiment end date","Consider increasing traffic allocation","Review targeting criteria to increase participant pool"],risks:[{description:"Longer experiments may be affected by external factors",probability:.3,impact:"medium"}]})}return i.statistics.power.observedPower<t.statistics.power&&s.push({type:"modify",title:"Insufficient Statistical Power",explanation:`Observed power (${(100*i.statistics.power.observedPower).toFixed(1)}%) is below target (${(100*t.statistics.power).toFixed(1)}%). Consider modifications to increase effect detection.`,confidence:.9,actions:["Increase sample size allocation","Review minimum detectable effect size","Consider more sensitive metrics"],risks:[{description:"Changes during experiment may introduce bias",probability:.4,impact:"high"}]}),r>t.duration.endTime&&"active"===t.status&&(i.statistics.overallSignificance?s.push({type:"stop",title:"Experiment Complete - Deploy Winner",explanation:"Experiment has reached its scheduled end with significant results.",confidence:i.winner?.confidence||.5,actions:["Stop experiment","Deploy winning variation","Analyze learnings"],risks:[]}):s.push({type:"stop",title:"Experiment Complete - No Clear Winner",explanation:"Experiment has ended without statistically significant results. Consider maintaining control or running follow-up experiments.",confidence:.7,actions:["Stop experiment","Maintain control variation","Plan follow-up experiments with larger effect sizes"],risks:[{description:"May miss small but meaningful improvements",probability:.3,impact:"low"}]})),s.sort((e,t)=>t.confidence-e.confidence)}onEvent(e){this.eventHandlers.push(e)}getActiveExperiments(){return Array.from(this.experiments.values()).filter(e=>"active"===e.status)}updateExperimentStatus(e,t){const i=this.experiments.get(e);i&&(i.status=t)}clearExperiment(e){this.experiments.delete(e),this.results.delete(e);for(const[t,i]of Array.from(this.participants.entries()))i.experimentId===e&&this.participants.delete(t);this.events=this.events.filter(t=>t.experimentId!==e)}validateExperimentConfig(e){if(!e.id||!e.name||!e.variations)throw new Error("Invalid experiment configuration: missing required fields");if(e.variations.length<2)throw new Error("Experiment must have at least 2 variations");const t=e.variations.reduce((e,t)=>e+t.traffic,0);if(Math.abs(t-100)>.01)throw new Error("Variation traffic percentages must sum to 100%");if(1!==e.variations.filter(e=>e.isControl).length)throw new Error("Experiment must have exactly one control variation")}meetsExperimentCriteria(e,t){const i=e.allocation.criteria;if(!i)return!0;if(i.include){if(!i.include.some(e=>this.evaluateCriterion(e,t)))return!1}if(i.exclude){if(i.exclude.some(e=>this.evaluateCriterion(e,t)))return!1}return!0}evaluateCriterion(e,t){if(e.includes("=")){const[i,s]=e.split("=");return t[i]?.toString().toLowerCase()===s.toLowerCase()}return void 0!==t[e]}selectVariation(e,t){const{allocation:i}=e;switch(i.method){case"random":default:return this.randomVariationAssignment(e.variations);case"hash":return this.hashVariationAssignment(e.variations,t);case"sticky":return this.stickyVariationAssignment(e.variations,t)}}randomVariationAssignment(e){const t=100*Math.random();let i=0;for(const s of e)if(i+=s.traffic,t<=i)return s.id;return e[0]?.id||null}hashVariationAssignment(e,t){let i=0;for(let e=0;e<t.length;e++){i=(i<<5)-i+t.charCodeAt(e),i&=i}const s=Math.abs(i)%100;let r=0;for(const t of e)if(r+=t.traffic,s<r)return t.id;return e[0]?.id||null}stickyVariationAssignment(e,t){const i=`sticky_${t}`,s=this.assignmentCache.get(i);if(s&&e.some(e=>e.id===s))return s;const r=this.hashVariationAssignment(e,t);return r&&this.assignmentCache.set(i,r),r}calculateExperimentResults(e){const t=this.events.filter(t=>t.experimentId===e.id),i=this.results.get(e.id);for(const s of e.variations){const r=t.filter(e=>e.variationId===s.id),n=i.variations[s.id];for(const t of e.metrics){const e=r.filter(e=>e.metricId===t.id);if(e.length>0){const i=e.map(e=>"number"==typeof e.value?e.value:e.value?1:0),s=i.reduce((e,t)=>e+t,0)/i.length,r=i.reduce((e,t)=>e+Math.pow(t-s,2),0)/(i.length-1),a=Math.sqrt(r/i.length),o=1.96,c=o*a;if(n.metrics[t.id]={value:s,standardError:a,confidenceInterval:[s-c,s+c],sampleCount:i.length},"conversion"===t.type){const e=i.filter(e=>e>0).length,t=e/n.sampleSize,s=o*Math.sqrt(t*(1-t)/n.sampleSize);n.conversions={conversions:e,conversionRate:t,confidenceInterval:[Math.max(0,t-s),Math.min(1,t+s)]}}}}}return this.performStatisticalTests(e,i),this.determineWinner(e,i),this.updatePowerAnalysis(e,i),i.analyzedAt=Date.now(),i}performStatisticalTests(e,t){const i=e.variations.find(e=>e.isControl);if(!i)return;const s=t.variations[i.id];for(const i of e.variations){if(i.isControl)continue;const r=t.variations[i.id];for(const n of e.metrics){const e=s.metrics[n.id],a=r.metrics[n.id];if(e&&a){const o=`${i.id}_${n.id}`;"conversion"===n.type?t.statistics.tests[o]=this.performZTest(s.conversions,r.conversions,s.sampleSize,r.sampleSize):t.statistics.tests[o]=this.performTTest(e,a)}}}this.applyMultipleComparisonsCorrection(t.statistics),t.statistics.overallSignificance=Object.values(t.statistics.tests).some(e=>e.isSignificant)}performTTest(e,t){const i=t.value-e.value,s=Math.sqrt(Math.pow(e.standardError,2)+Math.pow(t.standardError,2)),r=s>0?i/s:0,n=e.sampleCount+t.sampleCount-2,a=this.approximateTTestPValue(Math.abs(r),n),o=Math.sqrt(((e.sampleCount-1)*Math.pow(e.standardError*Math.sqrt(e.sampleCount),2)+(t.sampleCount-1)*Math.pow(t.standardError*Math.sqrt(t.sampleCount),2))/n);return{testType:"ttest",pValue:a,statistic:r,isSignificant:a<.05,effectSize:o>0?i/o:0,confidenceInterval:[i-1.96*s,i+1.96*s]}}performZTest(e,t,i,s){if(!e||!t)return{testType:"ztest",pValue:1,statistic:0,isSignificant:!1,effectSize:0,confidenceInterval:[0,0]};const r=e.conversionRate,n=t.conversionRate,a=i,o=s,c=(e.conversions+t.conversions)/(a+o),l=Math.sqrt(c*(1-c)*(1/a+1/o)),u=l>0?(n-r)/l:0,h=2*(1-this.standardNormalCDF(Math.abs(u)));return{testType:"ztest",pValue:h,statistic:u,isSignificant:h<.05,effectSize:r>0?(n-r)/r:0,confidenceInterval:[n-r-1.96*l,n-r+1.96*l]}}applyMultipleComparisonsCorrection(e){const t=Object.values(e.tests).map(e=>e.pValue),i=t.map((e,t)=>({p:e,index:t})).sort((e,t)=>e.p-t.p),s={},r=Object.keys(e.tests);for(let e=i.length-1;e>=0;e--){const{p:n,index:a}=i[e],o=Math.min(1,n*t.length/(e+1)),c=e<i.length-1?s[r[i[e+1].index]]:1;s[r[a]]=Math.min(o,c)}e.multipleComparisons.adjustedPValues=s;for(const[t,i]of Object.entries(e.tests)){const e=s[t];void 0!==e&&(i.isSignificant=e<.05)}}determineWinner(e,t){const i=Object.entries(t.statistics.tests).filter(([,e])=>e.isSignificant);if(0===i.length)return void delete t.winner;let s=null,r=-1/0,n=0;for(const t of e.variations){if(t.isControl)continue;const a=i.filter(([i])=>{const[s,r]=i.split("_"),n=e.metrics.find(e=>e.id===r);return s===t.id&&"primary"===n?.priority});if(a.length>0){const e=a.reduce((e,[,t])=>e+t.effectSize,0)/a.length,i=1-a.reduce((e,[,t])=>e+t.pValue,0)/a.length;e>r&&(s=t.id,r=e,n=i)}}s&&(t.winner={variationId:s,confidence:Math.min(.99,n),lift:r})}updatePowerAnalysis(e,t){const i=t.sampleSize.total,s=e.duration.minSampleSize,r=Math.min(1,i/s);t.statistics.power={observedPower:r,requiredSampleSize:s,actualSampleSize:i}}approximateTTestPValue(e,t){return t>30?2*(1-this.standardNormalCDF(e)):Math.min(1,2*Math.exp(-.5*e*e))}standardNormalCDF(e){return.5*(1+this.erf(e/Math.sqrt(2)))}erf(e){const t=e>=0?1:-1,i=1/(1+.3275911*(e=Math.abs(e)));return t*(1-((((1.061405429*i-1.453152027)*i+1.421413741)*i-.284496736)*i+.254829592)*i*Math.exp(-e*e))}scheduleResultsUpdate(e){const t=`update_${e}`;this[t]&&clearTimeout(this[t]),this[t]=setTimeout(()=>{this.analyzeExperiment(e),delete this[t]},1e4)}setupCleanupSchedule(){setInterval(()=>{const e=Date.now()-2592e6;this.events=this.events.filter(t=>t.timestamp>e);for(const[t,i]of Array.from(this.participants.entries())){const s=this.experiments.get(i.experimentId);(!s||"completed"===s.status||"cancelled"===s.status||i.assignedAt<e)&&this.participants.delete(t)}},864e5)}}new b;const v={regulations:["GDPR"],requireConsent:!0,consentExpirationDays:365,dataRetentionDays:90,enableAnonymization:!0,dataSubjectRights:{access:!0,rectification:!0,erasure:!0,portability:!0,objection:!0},geoDetection:{enabled:!0,anonymizeIP:!0,defaultRegion:"EU"}},C={anonymizeIPs:!0,anonymizeUserAgent:!0,anonymizeQueries:!1,anonymizeResults:!1,salt:"universal-search-privacy-salt",piiPatterns:[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,/\b\d{3}-\d{2}-\d{4}\b/g,/\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g,/\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/g],replacementStrategies:{email:"hash",ssn:"remove",phone:"pseudonymize",ip:"hash",userAgent:"generalize"}};class T{constructor(e={},t={}){this.consentRecords=new Map,this.processingRecords=[],this.dataSubjectRequests=new Map,this.complianceCheckers=new Map,this.metricsCache=null,this.metricsCacheTimestamp=0,this.config={...v,...e},this.anonymizationConfig={...C,...t},this.initialize()}requiresConsent(e,t="analytics"){if(!this.config.requireConsent)return!1;const i=this.detectUserRegion(e),s=this.isRegulatedRegion(i);return"necessary"!==t&&s}recordConsent(e,t,i="explicit",s="consent",r={}){const n=`consent_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=Date.now(),o=a+24*this.config.consentExpirationDays*60*60*1e3,c={necessary:"granted",analytics:t.analytics||"pending",performance:t.performance||"pending",functional:t.functional||"pending",targeting:t.targeting||"pending",social:t.social||"pending"},l={id:n,userId:e,categories:c,timestamp:a,expiresAt:o,method:i,legalBasis:s,userAgent:r.userAgent,ipHash:r.ipAddress?this.anonymizeIP(r.ipAddress):void 0,location:this.detectLocation(r.ipAddress),consentString:this.generateConsentString(c,i,s)};return this.consentRecords.set(e,l),this.metricsCache=null,l}checkConsent(e,t){const i=this.consentRecords.get(e);return i?Date.now()>i.expiresAt?"expired":i.categories[t]||"pending":this.requiresConsent(e,t)?"pending":"granted"}withdrawConsent(e,t){const i=this.consentRecords.get(e);if(!i)return!1;const s=t||Object.keys(i.categories);for(const e of s)"necessary"!==e&&(i.categories[e]="withdrawn");return i.timestamp=Date.now(),this.metricsCache=null,this.recordProcessing(e,"consent-withdrawal",s,"Consent withdrawn by user","consent",i.id),!0}recordProcessing(e,t,i,s,r,n){const a=`processing_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=Date.now(),c={id:a,dataSubjectId:e,activity:t,dataCategories:i,purpose:s,legalBasis:r,timestamp:o,retainUntil:o+24*this.config.dataRetentionDays*60*60*1e3,consentId:n};this.processingRecords.push(c);const l=o-24*(this.config.dataRetentionDays+30)*60*60*1e3;return this.processingRecords=this.processingRecords.filter(e=>e.timestamp>l),this.metricsCache=null,c}anonymizeData(e,t){if(!this.config.enableAnonymization)return e;const i={...e};this.anonymizationConfig.anonymizeIPs&&i.ipAddress&&(i.ipAddress=this.anonymizeIP(i.ipAddress)),this.anonymizationConfig.anonymizeUserAgent&&i.userAgent&&(i.userAgent=this.anonymizeUserAgent(i.userAgent)),this.anonymizationConfig.anonymizeQueries&&i.query&&(i.query=this.anonymizeText(i.query)),this.anonymizationConfig.anonymizeResults&&i.results&&(i.results=this.anonymizeResults(i.results));for(const[e,t]of Object.entries(i))"string"==typeof t&&(i[e]=this.detectAndAnonymizePII(t));return i}handleDataSubjectRequest(e,t,i,s){const r=`request_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n=Date.now(),a={id:r,dataSubjectId:e,type:t,status:"received",details:i,categories:s,requestedAt:n,deadline:n+2592e6};return this.dataSubjectRequests.set(r,a),this.metricsCache=null,this.processDataSubjectRequest(r),a}async processDataSubjectRequest(e){const t=this.dataSubjectRequests.get(e);if(t&&"received"===t.status){t.status="processing";try{switch(t.type){case"access":await this.processAccessRequest(t);break;case"erasure":await this.processErasureRequest(t);break;case"portability":await this.processPortabilityRequest(t);break;case"objection":await this.processObjectionRequest(t);break;case"rectification":await this.processRectificationRequest(t);break;case"restriction":await this.processRestrictionRequest(t)}t.status="completed",t.completedAt=Date.now()}catch(e){t.status="rejected",t.completedAt=Date.now(),t.response={action:"rejected",notes:`Error processing request: ${e.message||"Unknown error"}`}}}}getPrivacyMetrics(){const e=Date.now();if(this.metricsCache&&e-this.metricsCacheTimestamp<6e4)return this.metricsCache;const t=this.calculatePrivacyMetrics();return this.metricsCache=t,this.metricsCacheTimestamp=e,t}checkCompliance(){const e=[];let t=100;for(const t of this.config.regulations){const i=this.checkRegulationCompliance(t);e.push(...i)}const i=e.filter(e=>"critical"===e.severity).length;t-=25*i,t-=15*e.filter(e=>"high"===e.severity).length,t-=8*e.filter(e=>"medium"===e.severity).length,t-=3*e.filter(e=>"low"===e.severity).length;const s=Math.max(0,t);return{isCompliant:s>=80&&0===i,score:s,issues:e}}cleanupExpiredData(){const e=Date.now();let t=0,i=0,s=0;for(const[i,s]of Array.from(this.consentRecords.entries()))e>s.expiresAt&&(this.consentRecords.delete(i),t++);const r=this.processingRecords.length;this.processingRecords=this.processingRecords.filter(t=>e<t.retainUntil),i=r-this.processingRecords.length;const n=e-31536e6;for(const[e,t]of Array.from(this.dataSubjectRequests.entries()))"completed"===t.status&&t.completedAt&&t.completedAt<n&&(this.dataSubjectRequests.delete(e),s++);return this.metricsCache=null,{removedConsents:t,removedProcessingRecords:i,removedRequests:s}}initialize(){setInterval(()=>{this.cleanupExpiredData()},864e5),this.setupComplianceCheckers()}detectUserRegion(e){if(this.config.geoDetection.enabled){const t=this.consentRecords.get(e);if(t?.location?.country)return t.location.country}return this.config.geoDetection.defaultRegion}isRegulatedRegion(e){const t={GDPR:["EU","EEA","GB"],CCPA:["US-CA"],LGPD:["BR"],PIPEDA:["CA"],PDPB:["SG"]};return this.config.regulations.some(i=>t[i]?.includes(e))}detectLocation(e){if(e&&this.config.geoDetection.enabled)return e.startsWith("192.168.")||e.startsWith("10.")||e.startsWith("172.")?{country:"local",region:"local"}:{country:"EU",region:"EU"}}anonymizeIP(e){if(!e)return"";if(e.includes(".")){const t=e.split(".");if(4===t.length)return`${t[0]}.${t[1]}.${t[2]}.0`}if(e.includes(":")){const t=e.split(":");if(t.length>=4)return`${t.slice(0,4).join(":")}::`}return this.hashString(e)}anonymizeUserAgent(e){if(e.includes("Chrome")){return`Chrome/${e.match(/Chrome\/(\d+)/)?.[1]||"unknown"}`}if(e.includes("Firefox")){return`Firefox/${e.match(/Firefox\/(\d+)/)?.[1]||"unknown"}`}return e.includes("Safari")&&!e.includes("Chrome")?"Safari":e.includes("Edge")?"Edge":"Unknown Browser"}anonymizeText(e){return this.detectAndAnonymizePII(e)}anonymizeResults(e){return e.map(e=>{if("object"==typeof e){const t={...e};return t.url&&(t.url=this.anonymizeURL(t.url)),t.title&&(t.title=this.detectAndAnonymizePII(t.title)),t.description&&(t.description=this.detectAndAnonymizePII(t.description)),t}return e})}anonymizeURL(e){try{const t=new URL(e);return`${t.protocol}//${t.hostname}${t.pathname}`}catch{return"[ANONYMIZED_URL]"}}detectAndAnonymizePII(e){let t=e;for(const e of this.anonymizationConfig.piiPatterns)t=t.replace(e,"[ANONYMIZED]");return t}hashString(e){const t=e+this.anonymizationConfig.salt;let i=0;for(let e=0;e<t.length;e++){i=(i<<5)-i+t.charCodeAt(e),i&=i}return`hash_${Math.abs(i).toString(36)}`}generateConsentString(e,t,i){return`consent:${Object.entries(e).filter(([,e])=>"granted"===e).map(([e])=>e).join(",")};method:${t};basis:${i};ts:${Date.now()}`}async processAccessRequest(e){const t=e.dataSubjectId,i=this.consentRecords.get(t),s=this.processingRecords.filter(e=>e.dataSubjectId===t),r=Array.from(this.dataSubjectRequests.values()).filter(e=>e.dataSubjectId===t),n={consent:i?{categories:i.categories,timestamp:i.timestamp,expiresAt:i.expiresAt,method:i.method,legalBasis:i.legalBasis}:null,processingActivities:s.map(e=>({activity:e.activity,purpose:e.purpose,legalBasis:e.legalBasis,timestamp:e.timestamp,dataCategories:e.dataCategories})),requests:r.map(e=>({type:e.type,status:e.status,requestedAt:e.requestedAt,completedAt:e.completedAt}))};e.response={data:n,action:"data-provided",notes:"Personal data access request fulfilled"}}async processErasureRequest(e){const t=e.dataSubjectId;this.consentRecords.delete(t);const i=this.processingRecords.filter(e=>e.dataSubjectId===t);this.processingRecords=this.processingRecords.filter(e=>e.dataSubjectId!==t),e.response={action:"data-erased",notes:`Erased ${i.length} processing records and consent data`}}async processPortabilityRequest(e){await this.processAccessRequest(e),e.response?.data&&(e.response.action="data-exported",e.response.notes="Data exported in portable JSON format")}async processObjectionRequest(e){const t=e.dataSubjectId;e.categories?this.withdrawConsent(t,e.categories):this.withdrawConsent(t,["analytics","performance","functional","targeting","social"]),e.response={action:"objection-processed",notes:"Processing objection recorded, consent withdrawn for specified categories"}}async processRectificationRequest(e){e.response={action:"rectification-recorded",notes:"Rectification request recorded for manual processing"}}async processRestrictionRequest(e){const t=e.dataSubjectId;this.recordProcessing(t,"processing-restriction",e.categories?.map(String)||["all"],"Data processing restriction requested by subject","legal-obligation"),e.response={action:"restriction-applied",notes:"Processing restriction recorded and applied"}}calculatePrivacyMetrics(){const e=Array.from(this.consentRecords.values()),t=Array.from(this.dataSubjectRequests.values()),i=Date.now(),s=e.length,r=e.filter(e=>Object.values(e.categories).some(e=>"granted"===e)).length,n=e.filter(e=>Object.values(e.categories).every(e=>"denied"===e)).length,a=e.filter(e=>Object.values(e.categories).some(e=>"withdrawn"===e)).length,o=e.filter(e=>i>e.expiresAt).length,c={necessary:0,analytics:0,performance:0,functional:0,targeting:0,social:0};for(const t of e)for(const[e,i]of Object.entries(t.categories))"granted"===i&&c[e]++;const l=this.processingRecords.length,u={},h={};let d=0;for(const e of this.processingRecords)u[e.purpose]=(u[e.purpose]||0)+1,h[e.legalBasis]=(h[e.legalBasis]||0)+1,d+=(e.retainUntil-e.timestamp)/864e5;const m=l>0?d/l:0,p=t.length,f={};let g=0,y=0;for(const e of t)f[e.type]=(f[e.type]||0)+1,"completed"===e.status&&e.completedAt&&(g+=e.completedAt-e.requestedAt,y++);const w=y>0?g/y:0,b=p>0?y/p:0,v=this.checkCompliance();return{consent:{totalRequests:s,grantedConsent:r,deniedConsent:n,withdrawnConsent:a,expiredConsent:o,consentByCategory:c,consentRateByRegion:{}},processing:{totalRecords:l,recordsByPurpose:u,recordsByLegalBasis:h,averageRetentionPeriod:m},requests:{totalRequests:p,requestsByType:f,averageResponseTime:w,completionRate:b},compliance:{score:v.score,issues:v.issues.map(e=>({type:e.issue,severity:e.severity,description:e.issue,count:1}))}}}checkRegulationCompliance(e){const t=[];switch(e){case"GDPR":t.push(...this.checkGDPRCompliance());break;case"CCPA":t.push(...this.checkCCPACompliance())}return t.map(t=>({...t,regulation:e}))}checkGDPRCompliance(){const e=[];Array.from(this.consentRecords.values()).filter(e=>!e.legalBasis).length>0&&e.push({issue:"Missing legal basis for processing",severity:"critical",recommendation:"Ensure all consent records have a valid legal basis"});return this.processingRecords.filter(e=>e.retainUntil-e.timestamp>31536e6).length>0&&e.push({issue:"Data retention periods may be excessive",severity:"medium",recommendation:"Review data retention periods to ensure compliance with data minimization principle"}),this.config.dataSubjectRights.erasure||e.push({issue:"Right to erasure not enabled",severity:"high",recommendation:"Enable right to erasure to comply with GDPR Article 17"}),e}checkCCPACompliance(){const e=[];return this.config.dataSubjectRights.objection||e.push({issue:"Right to opt-out not enabled",severity:"high",recommendation:"Enable right to object/opt-out to comply with CCPA"}),e}setupComplianceCheckers(){this.complianceCheckers.set("GDPR",e=>0===this.checkGDPRCompliance().length),this.complianceCheckers.set("CCPA",e=>0===this.checkCCPACompliance().length)}}new T;class E{constructor(e,t,i,s,r){this.performanceTracker=e,this.analyticsCollector=t,this.browserProfiler=i,this.experimentManager=s,this.privacyManager=r,this.exportJobs=new Map,this.streamingConnections=new Map,this.alertRules=new Map,this.metricsBuffer=[]}async exportMetrics(e){const t=await this.collectDashboardMetrics(e.filter),i=await this.formatMetrics(t,e.format);await this.deliverMetrics(i,e.destination)}async scheduleExport(e,t){if(!t.schedule)throw new Error("Schedule configuration required for scheduled exports");this.cancelScheduledExport(e);const i=this.parseCronExpression(t.schedule.cron),s=setInterval(async()=>{try{await this.exportMetrics(t)}catch(t){await this.handleExportError(e,t)}},i);this.exportJobs.set(e,s)}cancelScheduledExport(e){const t=this.exportJobs.get(e);t&&(clearInterval(t),this.exportJobs.delete(e))}async startStreaming(e,t){if(!t.streaming?.enabled)throw new Error("Streaming configuration required");const i=new WebSocket(t.destination.endpoint);this.streamingConnections.set(e,i);const s=setInterval(async()=>{if(this.metricsBuffer.length>=(t.streaming?.bufferSize??100)){const e=[...this.metricsBuffer];this.metricsBuffer=[];const s=await this.formatMetrics(e,t.format);i.send(JSON.stringify(s))}},t.streaming.flushInterval);i.on("close",()=>{clearInterval(s),this.streamingConnections.delete(e)})}stopStreaming(e){const t=this.streamingConnections.get(e);t&&(t.close(),this.streamingConnections.delete(e))}addAlertRule(e){this.alertRules.set(e.id,e)}removeAlertRule(e){this.alertRules.delete(e)}async checkAlerts(e){const t=[];for(const i of Array.from(this.alertRules.values())){if(!i.enabled)continue;const s=this.getMetricValue(e,i.metric);if(void 0===s)continue;if(this.evaluateCondition(s,i.condition)){const r={ruleId:i.id,timestamp:new Date,severity:i.severity,message:`${i.name}: ${i.metric} is ${s} (threshold: ${i.condition.threshold})`,currentValue:s,threshold:i.condition.threshold,context:{rule:i,metrics:e}};t.push(r),await this.sendAlert(r,i.channels)}}return t}async collectDashboardMetrics(e){const t=new Date;e?.timeRange??new Date(t.getTime()-36e5);const i=await this.performanceTracker.getMetricsSummary(),s=await this.analyticsCollector.getAnalyticsSummary(),r=await this.browserProfiler.getCurrentProfile(),n=await this.experimentManager.getExperimentSummary(),a=await this.privacyManager.getPrivacyMetrics(),o={timestamp:t,performance:{responseTime:i.responseTime.avg,renderTime:i.renderTime.avg,interactionLatency:i.interactionLatency.avg,fps:i.renderTime.targetFps,memoryUsage:i.memoryUsage||0,cacheHitRate:i.cachePerformance.hitRate},usage:{activeUsers:s.activeUsers,pageViews:s.pageViews,searchQueries:s.searchQueries,conversionRate:s.conversionRate,bounceRate:s.bounceRate,sessionDuration:s.averageSessionDuration},browser:{compatibilityScore:r.compatibilityScore,performanceScore:r.performanceScore,recommendations:r.recommendations||[]},experiments:{activeExperiments:n.activeCount,completedTests:n.completedCount,significantResults:n.significantResults},privacy:{consentRate:a.consentRate||0,dataProcessed:a.dataProcessed||0,complianceScore:a.compliance?.score||0}},c=this.applyFilter([o],e);return this.metricsBuffer.push(...c),c}async formatMetrics(e,t){switch(t.format){case"json":return JSON.stringify(e,null,2);case"csv":return this.formatCsv(e);case"prometheus":return this.formatPrometheus(e);case"elasticsearch":return this.formatElasticsearch(e);default:throw new Error(`Unsupported export format: ${t.format}`)}}formatCsv(e){if(0===e.length)return"";const t=e.map(e=>[e.timestamp.toISOString(),e.performance.responseTime,e.performance.renderTime,e.performance.interactionLatency,e.performance.fps,e.performance.memoryUsage,e.performance.cacheHitRate,e.usage.activeUsers,e.usage.pageViews,e.usage.searchQueries,e.usage.conversionRate,e.usage.bounceRate,e.usage.sessionDuration,e.browser.compatibilityScore,e.browser.performanceScore,e.experiments.activeExperiments,e.experiments.completedTests,e.experiments.significantResults,e.privacy.consentRate,e.privacy.dataProcessed,e.privacy.complianceScore]);return[["timestamp","response_time","render_time","interaction_latency","fps","memory_usage","cache_hit_rate","active_users","page_views","search_queries","conversion_rate","bounce_rate","session_duration","compatibility_score","performance_score","active_experiments","completed_tests","significant_results","consent_rate","data_processed","compliance_score"].join(","),...t.map(e=>e.join(","))].join("\n")}formatPrometheus(e){const t=e[e.length-1];if(!t)return"";const i=t.timestamp.getTime();return["# HELP performance_response_time Average response time in milliseconds","# TYPE performance_response_time gauge",`performance_response_time ${t.performance.responseTime} ${i}`,"","# HELP usage_active_users Number of active users","# TYPE usage_active_users gauge",`usage_active_users ${t.usage.activeUsers} ${i}`,"","# HELP browser_compatibility_score Browser compatibility score (0-100)","# TYPE browser_compatibility_score gauge",`browser_compatibility_score ${t.browser.compatibilityScore} ${i}`,"","# HELP experiments_active_count Number of active experiments","# TYPE experiments_active_count gauge",`experiments_active_count ${t.experiments.activeExperiments} ${i}`,"","# HELP privacy_compliance_score Privacy compliance score (0-100)","# TYPE privacy_compliance_score gauge",`privacy_compliance_score ${t.privacy.complianceScore} ${i}`].join("\n")}formatElasticsearch(e){return e.map(e=>({"@timestamp":e.timestamp.toISOString(),performance:e.performance,usage:e.usage,browser:e.browser,experiments:e.experiments,privacy:e.privacy})).map(e=>JSON.stringify({index:{}})+"\n"+JSON.stringify(e)).join("\n")+"\n"}async deliverMetrics(e,t){switch(t.type){case"file":await this.writeToFile(e,t.endpoint);break;case"http":case"webhook":await this.sendToEndpoint(e,t);break;case"stream":await this.sendToStream(e,t.endpoint);break;default:throw new Error(`Unsupported destination type: ${t.type}`)}}async writeToFile(e,t){}async sendToEndpoint(e,t){const i={"Content-Type":"application/json",...t.authentication&&this.getAuthHeaders(t.authentication)},s=await fetch(t.endpoint,{method:"POST",headers:i,body:e});if(!s.ok)throw new Error(`HTTP export failed: ${s.status} ${s.statusText}`)}async sendToStream(e,t){}getAuthHeaders(e){if(!e)return{};switch(e.type){case"bearer":return{Authorization:`Bearer ${e.credentials.token}`};case"basic":return{Authorization:`Basic ${btoa(`${e.credentials.username}:${e.credentials.password}`)}`};case"api-key":return{"X-API-Key":e.credentials.key};default:return{}}}applyFilter(e,t){if(!t)return e;let i=e;if(t.timeRange&&(i=i.filter(e=>e.timestamp>=t.timeRange.start&&e.timestamp<=t.timeRange.end)),t.threshold&&(i=i.filter(e=>{const i=this.getMetricValue(e,t.threshold.metric);return void 0!==i&&this.evaluateCondition(i,t.threshold)})),t.sampling&&t.sampling.rate<1){const e=Math.ceil(i.length*t.sampling.rate);switch(t.sampling.strategy){case"random":i=this.randomSample(i,e);break;case"systematic":i=this.systematicSample(i,e);break;case"stratified":i=this.stratifiedSample(i,e)}}return i}getMetricValue(e,t){const i=t.split(".");let s=e;for(const e of i)s=s?.[e];return"number"==typeof s?s:void 0}evaluateCondition(e,t){switch(t.operator){case">":return e>t.threshold;case"<":return e<t.threshold;case"=":return e===t.threshold;case">=":return e>=t.threshold;case"<=":return e<=t.threshold;default:return!1}}randomSample(e,t){return[...e].sort(()=>.5-Math.random()).slice(0,t)}systematicSample(e,t){if(t>=e.length)return e;const i=Math.floor(e.length/t),s=[];for(let r=0;r<e.length&&(s.push(e[r]),!(s.length>=t));r+=i);return s}stratifiedSample(e,t){return this.systematicSample(e,t)}parseCronExpression(e){const t=e.split(" ");if(t.length>=2){const e=parseInt(t[0])||0;return 60*(60*(parseInt(t[1])||0)+e)*1e3}return 36e5}async sendAlert(e,t){for(const e of t);}async handleExportError(e,t){}dispose(){for(const e of Array.from(this.exportJobs.values()))clearInterval(e);this.exportJobs.clear();for(const e of Array.from(this.streamingConnections.values()))e.close();this.streamingConnections.clear()}}class S{constructor(e,i={}){this.targetElement=null,this.initialized=!1,this.destroyed=!1,this.eventListeners={},this.state={query:"",results:[],loading:!1,error:null,hasMore:!1,total:0},this.memoryAdapter=null,this.queryProcessor=null,this.responseTransformer=null,this.searchInput=null,this.resultsDropdown=null,this.debounceTimer=null,this.performanceTracker=null,this.analyticsCollector=null,this.browserProfiler=null,this.experimentManager=null,this.privacyManager=null,this.metricsExporter=null;try{!function(e){if(!e||"string"!=typeof e)throw new t("Selector must be a non-empty string");if(0===e.trim().length)throw new t("Selector cannot be empty or whitespace only");try{document.querySelector(e)}catch(i){throw new t(`Invalid CSS selector: ${e}`)}}(e),this.selector=e,function(e){if(!e||"object"!=typeof e)throw new t("Configuration must be an object");if(e.queryHandling){const{queryHandling:i}=e;if("number"==typeof i.minLength&&i.minLength<0)throw new t("minLength must be a non-negative number","queryHandling.minLength");if("number"==typeof i.debounceMs&&i.debounceMs<0)throw new t("debounceMs must be a non-negative number","queryHandling.debounceMs");if(i.triggerOn&&!["change","enter","both"].includes(i.triggerOn))throw new t("triggerOn must be one of: change, enter, both","queryHandling.triggerOn");if(i.matchMode&&!["exact","partial","fuzzy"].includes(i.matchMode))throw new t("matchMode must be one of: exact, partial, fuzzy","queryHandling.matchMode")}if(e.ui){const{ui:i}=e;if("number"==typeof i.maxResults&&(i.maxResults<1||i.maxResults>1e3))throw new t("maxResults must be between 1 and 1000","ui.maxResults");if("string"==typeof i.placeholder&&i.placeholder.length>200)throw new t("placeholder must be 200 characters or less","ui.placeholder")}if(e.dataSource){const{dataSource:i}=e;if(!["api","sql","memory","dom"].includes(i.type))throw new t("dataSource.type must be one of: api, sql, memory, dom","dataSource.type");if("api"===i.type&&i.url&&"string"!=typeof i.url)throw new t("dataSource.url must be a string","dataSource.url")}}(i),this.config=Object.freeze(this.mergeConfig(i)),this.config.debug}catch(e){const s=e instanceof t?e:new t(`Failed to create UniversalSearch instance: ${e}`);throw i.debug,s}}init(){if(this.destroyed)throw new t("Cannot initialize destroyed component instance");if(this.initialized)this.config.debug;else try{const e=document.querySelector(this.selector);!function(e,i){if(!e)throw new t(`Element not found for selector: ${i}`);if(!("undefined"!=typeof HTMLElement&&e instanceof HTMLElement||e&&"function"==typeof e.setAttribute&&void 0!==e.classList&&"http://www.w3.org/1999/xhtml"===e.namespaceURI))throw new t(`Target element must be an HTMLElement, got: ${e.constructor.name}`);if("isConnected"in e&&!e.isConnected)throw new t("Target element is not connected to the DOM")}(e,this.selector),this.targetElement=e,this.setupDomStructure(),this.initializeSearchPipeline(),this.initializeUIComponents(),this.initializeEventSystem(),this.initializeMonitoring(),this.setupEventHandlers(),this.applyConfiguration(),this.initialized=!0,this.config.debug,this.emit({type:"search:start",timestamp:Date.now(),target:this.targetElement,query:""})}catch(e){const i=e instanceof t?e:new t(`Initialization failed: ${e}`);throw this.config.debug,i}}destroy(){if(this.destroyed)this.config.debug;else try{this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.searchInput&&(this.searchInput.destroy(),this.searchInput=null),this.resultsDropdown&&(this.resultsDropdown.destroy(),this.resultsDropdown=null),this.cleanupEventListeners(),this.cleanupDomStructure(),this.memoryAdapter=null,this.queryProcessor=null,this.responseTransformer=null,this.cleanupMonitoring(),this.state={query:"",results:[],loading:!1,error:null,hasMore:!1,total:0},this.initialized=!1,this.destroyed=!0,this.targetElement=null,this.config.debug}catch(e){this.config.debug}}getConfig(){return this.config}getResults(){return[...this.state.results]}getQuery(){return this.state.query}async search(e){if(!this.initialized)throw new t("Component must be initialized before searching");if(!this.queryProcessor||!this.memoryAdapter||!this.responseTransformer)throw new t("Search pipeline not initialized");try{const t=this.queryProcessor.processQuery(e);if(!t.isValid)return this.setState({query:t.original,loading:!1,error:new Error(t.error||"Invalid query"),results:[]}),[];this.setState({query:t.original,loading:!0,error:null}),this.emit({type:"search:start",timestamp:Date.now(),target:this.targetElement,query:t.normalized});const i=this.memoryAdapter.search(t.normalized),s=this.responseTransformer.transformResults(i,{query:t.normalized,timestamp:Date.now(),totalResults:i.length,sourceType:"memory"});return this.setState({results:s,loading:!1,total:s.length,hasMore:!1}),this.resultsDropdown&&(s.length>0?this.resultsDropdown.showResults(s):this.resultsDropdown.showNoResults()),this.emit({type:"search:complete",timestamp:Date.now(),target:this.targetElement,query:t.normalized,results:s,duration:0}),s}catch(t){const i=t instanceof Error?t:new Error("Search failed");throw this.setState({loading:!1,error:i,results:[]}),this.resultsDropdown&&this.resultsDropdown.showError(i.message),this.emit({type:"search:error",timestamp:Date.now(),target:this.targetElement,query:e,error:i}),i}}clearResults(){this.setState({query:"",results:[],loading:!1,error:null,total:0,hasMore:!1}),this.searchInput&&this.searchInput.setValue(""),this.resultsDropdown&&this.resultsDropdown.clearResults()}focus(){this.searchInput&&this.searchInput.focus()}blur(){this.searchInput&&this.searchInput.blur()}on(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}off(e,t){const i=this.eventListeners[e];if(i){const e=i.indexOf(t);e>-1&&i.splice(e,1)}}emit(e){const t=this.eventListeners[e.type];t&&t.forEach(t=>{try{t(e)}catch(e){this.config.debug}})}mergeConfig(t){return{...e,...t,queryHandling:{...e.queryHandling,...t.queryHandling},ui:{...e.ui,...t.ui},dataSource:{...e.dataSource,...t.dataSource}}}setupDomStructure(){if(!this.targetElement)throw new t("Target element not found");this.targetElement.classList.add(`${this.config.classPrefix}`),this.targetElement.setAttribute("role","combobox"),this.targetElement.setAttribute("aria-expanded","false"),this.targetElement.setAttribute("aria-haspopup","listbox"),this.config.ui.rtl&&this.targetElement.setAttribute("dir","rtl")}initializeEventSystem(){this.config.debug}applyConfiguration(){this.targetElement&&"default"!==this.config.ui.theme&&this.targetElement.classList.add(`${this.config.classPrefix}--${this.config.ui.theme}`)}cleanupEventListeners(){this.eventListeners={}}cleanupDomStructure(){this.targetElement&&(this.targetElement.classList.remove(`${this.config.classPrefix}`),"default"!==this.config.ui.theme&&this.targetElement.classList.remove(`${this.config.classPrefix}--${this.config.ui.theme}`),this.targetElement.removeAttribute("role"),this.targetElement.removeAttribute("aria-expanded"),this.targetElement.removeAttribute("aria-haspopup"),this.targetElement.removeAttribute("dir"))}initializeSearchPipeline(){try{if(this.queryProcessor=new h(this.config.queryHandling),"memory"===this.config.dataSource.type){const e={data:this.config.dataSource.data||[],searchFields:this.config.dataSource.searchFields||["title"],caseSensitive:this.config.queryHandling.caseSensitive,updateStrategy:"static"};this.memoryAdapter=new s(e)}const e={labelField:this.config.dataSource.labelField||"title",valueField:this.config.dataSource.valueField,metadataFields:this.config.dataSource.metadataFields};this.responseTransformer=new d(e),this.config.debug}catch(e){throw new t(`Failed to initialize search pipeline: ${e}`)}}initializeUIComponents(){if(!this.targetElement)throw new t("Target element not found");try{this.searchInput=new m(this.targetElement,this.config.ui),this.searchInput.init(),this.resultsDropdown=new p(this.targetElement,this.config.ui),this.resultsDropdown.init(),this.config.debug}catch(e){throw new t(`Failed to initialize UI components: ${e}`)}}setupEventHandlers(){this.searchInput&&this.resultsDropdown&&(this.searchInput.on("input",e=>{this.handleSearchInput(e)}),this.searchInput.on("keydown",e=>{this.handleKeydown(e)}),this.searchInput.on("focus",()=>{this.state.results.length>0&&this.resultsDropdown?.show()}),this.searchInput.on("blur",()=>{setTimeout(()=>{this.resultsDropdown?.hide()},150)}),this.resultsDropdown.on("select",(e,t)=>{this.handleResultSelection(e,t)}))}handleSearchInput(e){this.debounceTimer&&clearTimeout(this.debounceTimer),0!==e.trim().length?(this.resultsDropdown&&this.resultsDropdown.showLoading(),this.debounceTimer=window.setTimeout(()=>{this.search(e).catch(e=>{this.config.debug})},this.config.queryHandling.debounceMs)):this.clearResults()}handleKeydown(e){if(this.resultsDropdown)switch(e.key){case"ArrowDown":e.preventDefault(),this.resultsDropdown.navigate("down");break;case"ArrowUp":e.preventDefault(),this.resultsDropdown.navigate("up");break;case"Enter":e.preventDefault(),this.resultsDropdown.selectCurrent();break;case"Escape":e.preventDefault(),this.resultsDropdown.hide(),this.searchInput?.blur()}}handleResultSelection(e,t){this.emit({type:"result:select",timestamp:Date.now(),target:this.targetElement,result:e,index:t}),this.resultsDropdown&&this.resultsDropdown.hide(),this.searchInput&&this.searchInput.setValue(e.title)}setState(e){this.state={...this.state,...e}}initializeMonitoring(){if(this.config.analytics?.enabled)try{this.performanceTracker=new f,this.analyticsCollector=new y,this.browserProfiler=new w,this.experimentManager=new b,this.privacyManager=new T,this.metricsExporter=new E,this.config.analytics&&this.analyticsCollector.configure({enabled:this.config.analytics.enabled,sampleRate:this.config.analytics.sampleRate||1,privacyMode:this.config.analytics.privacyMode||"balanced",retentionDays:this.config.analytics.retentionDays||30,intervals:{metrics:5e3,usage:1e4,performance:1e3},export:{enabled:!1,interval:6e4,formats:["json"],destinations:[]},privacy:{requireConsent:this.config.analytics.requireConsent||!1,anonymize:this.config.analytics.anonymize||!0,anonymizeIp:!0,hashUserId:!0}}),this.config.debug}catch(e){this.config.debug}}cleanupMonitoring(){try{this.performanceTracker&&(this.performanceTracker.cleanup(),this.performanceTracker=null),this.analyticsCollector&&(this.analyticsCollector.cleanup(),this.analyticsCollector=null),this.browserProfiler&&(this.browserProfiler.cleanup(),this.browserProfiler=null),this.experimentManager&&(this.experimentManager.cleanup(),this.experimentManager=null),this.privacyManager&&(this.privacyManager.cleanup(),this.privacyManager=null),this.metricsExporter&&(this.metricsExporter.cleanup(),this.metricsExporter=null)}catch(e){this.config.debug}}trackPerformance(e){this.performanceTracker&&this.performanceTracker.recordMetrics(e)}trackUsage(e,t){if(this.analyticsCollector){const i={id:`${e}_${Date.now()}_${Math.random().toString(36)}`,type:e,properties:t||{},context:{sessionId:this.getSessionId(),timestamp:Date.now(),location:{url:"undefined"!=typeof window?window.location.href:"",pathname:"undefined"!=typeof window?window.location.pathname:""}},timestamp:Date.now(),privacy:{anonymized:this.config.analytics?.anonymize||!0,consented:!this.config.analytics?.requireConsent||this.hasUserConsent()}};this.analyticsCollector.track(i)}}exportMetrics(e="json"){return this.metricsExporter?this.metricsExporter.export(e,{start:Date.now()-864e5,end:Date.now()}):Promise.resolve("{}")}getPerformanceMetrics(){return this.performanceTracker?this.performanceTracker.getMetricsSummary():null}getSessionId(){if("undefined"!=typeof window&&window.sessionStorage){let e=window.sessionStorage.getItem("universal-search-session-id");return e||(e=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,window.sessionStorage.setItem("universal-search-session-id",e)),e}return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}hasUserConsent(){return!this.privacyManager||this.privacyManager.hasConsent("analytics")}}const R=new class{constructor(){this.tokenCache=new Map,this.refreshPromises=new Map}async getAuthHeaders(e,i){if(!e||"none"===e.type)return{};switch(e.type){case"apikey":return this.getApiKeyHeaders(e);case"bearer":return await this.getBearerHeaders(e,i);case"oauth2":return await this.getOAuth2Headers(e,i);case"basic":return this.getBasicHeaders(e);default:throw new t(`Unsupported authentication type: ${e.type}`)}}getApiKeyHeaders(e){if(!e.apiKey?.key)throw new t("API key is required for apikey authentication");const i={};return i[e.apiKey.header||"X-API-Key"]=e.apiKey.key,i}async getBearerHeaders(e,i){if(!e.bearer?.token)throw new t("Bearer token is required for bearer authentication");let s=e.bearer.token;return this.isTokenExpired(e.bearer)&&(s=await this.refreshBearerToken(e,i)),{Authorization:`Bearer ${s}`}}async getOAuth2Headers(e,i){if(!e.oauth2)throw new t("OAuth2 configuration is required for oauth2 authentication");const s=this.getTokenCacheKey(e,i);let r=this.tokenCache.get(s);return r&&!this.isTokenExpired(r)||(r=await this.getOAuth2Token(e,i),this.tokenCache.set(s,r)),{Authorization:`${r.type} ${r.token}`}}getBasicHeaders(e){if(!e.basic?.username||!e.basic?.password)throw new t("Username and password are required for basic authentication");return{Authorization:`Basic ${btoa(`${e.basic.username}:${e.basic.password}`)}`}}isTokenExpired(e){if(!e.expiresAt)return!1;return Date.now()>=e.expiresAt-3e5}async refreshBearerToken(e,i){if(!e.bearer?.refreshToken||!e.bearer?.refreshUrl)throw new t("Refresh token and URL are required for token refresh");const s=`refresh-${this.getTokenCacheKey(e,i)}`;if(this.refreshPromises.has(s)){return(await this.refreshPromises.get(s)).token}const r=this.performTokenRefresh(e,i);this.refreshPromises.set(s,r);try{return(await r).token}finally{this.refreshPromises.delete(s)}}async performTokenRefresh(e,t){const i=this.resolveUrl(e.bearer.refreshUrl,t),s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e.bearer.refreshToken}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e.bearer.refreshToken})});if(!s.ok)throw new Error(`Token refresh failed: ${s.status} ${s.statusText}`);const r=await s.json();return{token:r.access_token,type:"Bearer",expiresAt:r.expires_in?Date.now()+1e3*r.expires_in:void 0,refreshToken:r.refresh_token||e.bearer.refreshToken}}async getOAuth2Token(e,i){if(!e.oauth2)throw new t("OAuth2 configuration is required");const s=this.getTokenCacheKey(e,i);if(this.refreshPromises.has(s))return await this.refreshPromises.get(s);const r=this.performOAuth2Request(e,i);this.refreshPromises.set(s,r);try{return await r}finally{this.refreshPromises.delete(s)}}async performOAuth2Request(e,i){const s=e.oauth2,r=this.resolveUrl(s.tokenUrl,i);let n;if("client_credentials"!==s.grantType)throw new t(`OAuth2 grant type '${s.grantType}' is not yet implemented`);n=new URLSearchParams({grant_type:"client_credentials",client_id:s.clientId}),s.clientSecret&&n.append("client_secret",s.clientSecret),s.scopes&&n.append("scope",s.scopes.join(" "));const a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n});if(!a.ok)throw new Error(`OAuth2 token request failed: ${a.status} ${a.statusText}`);const o=await a.json();return{token:o.accessToken,type:o.tokenType||"Bearer",expiresAt:o.expiresIn?Date.now()+1e3*o.expiresIn:void 0,scopes:o.scopes}}getTokenCacheKey(e,t){const i=JSON.stringify({type:e.type,oauth2:e.oauth2?{clientId:e.oauth2.clientId,tokenUrl:e.oauth2.tokenUrl,scopes:e.oauth2.scopes}:void 0,bearer:e.bearer?{refreshUrl:e.bearer.refreshUrl}:void 0});return`${t}-${btoa(i)}`}resolveUrl(e,t){if(e.startsWith("http://")||e.startsWith("https://"))return e;return`${t.endsWith("/")?t.slice(0,-1):t}${e.startsWith("/")?e:`/${e}`}`}clearTokenCache(){this.tokenCache.clear(),this.refreshPromises.clear()}getCachedToken(e,t){return this.tokenCache.get(this.getTokenCacheKey(e,t))}setCachedToken(e,t,i){this.tokenCache.set(this.getTokenCacheKey(e,t),i)}};const x=new class{transformRequest(e,t,i={}){const s=new URL(t.url),r=t.method||"GET",n={...i,...t.headers};return t.requestTransform?.dynamicHeaders&&Object.assign(n,this.generateDynamicHeaders(t.requestTransform.dynamicHeaders,e)),"GET"===r?this.transformGetRequest(e,t,s,n):this.transformPostRequest(e,t,s,n)}transformGetRequest(e,t,i,s){const r=t.queryParam||"q",n=this.transformQueryValue(e.normalized,t.requestTransform);if(i.searchParams.set(r,n),t.requestTransform?.additionalParams)for(const[e,s]of Object.entries(t.requestTransform.additionalParams))i.searchParams.set(e,String(s));return{url:i.toString(),method:"GET",headers:s,timeout:t.timeout}}transformPostRequest(e,t,i,s){const r=this.transformQueryValue(e.normalized,t.requestTransform);let n;if(t.requestTransform?.graphql)n=this.buildGraphQLRequest(r,t.requestTransform.graphql,e),s["Content-Type"]="application/json";else{const e=t.requestTransform?.queryMapping?.field||"query";n={[e]:r},t.requestTransform?.additionalParams&&Object.assign(n,t.requestTransform.additionalParams),s["Content-Type"]="application/json"}return{url:i.toString(),method:t.method||"POST",headers:s,body:JSON.stringify(n),timeout:t.timeout}}transformQueryValue(e,t){if(!t?.queryMapping?.transform)return e;switch(t.queryMapping.transform){case"lowercase":return e.toLowerCase();case"uppercase":return e.toUpperCase();case"trim":return e.trim();case"encode":return encodeURIComponent(e);default:return e}}generateDynamicHeaders(e,t){const i={};for(const[s,r]of Object.entries(e))i[s]=this.interpolateTemplate(r,{query:t.normalized,originalQuery:t.original,timestamp:Date.now().toString(),uuid:this.generateUUID()});return i}buildGraphQLRequest(e,t,i){const s={...t.variables,query:e,originalQuery:i.original};return{query:t.query,variables:s,operationName:t.operationName}}interpolateTemplate(e,t){return e.replace(/\{\{(\w+)\}\}/g,(e,i)=>t[i]||e)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}validateTransformConfig(e){if(e.queryMapping?.field&&"string"!=typeof e.queryMapping.field)throw new t("Query mapping field must be a string");if(e.queryMapping?.transform&&!["lowercase","uppercase","trim","encode"].includes(e.queryMapping.transform))throw new t("Invalid query transform type");if(e.additionalParams&&"object"!=typeof e.additionalParams)throw new t("Additional params must be an object");if(e.dynamicHeaders&&"object"!=typeof e.dynamicHeaders)throw new t("Dynamic headers must be an object");if(e.graphql&&(!e.graphql.query||"string"!=typeof e.graphql.query))throw new t("GraphQL query is required and must be a string")}extractSearchParams(e){try{const t=new URL(e),i={};for(const[e,s]of t.searchParams.entries())i[e]=s;return i}catch(i){throw new t(`Invalid URL: ${e}`)}}parseRequestBody(e){if("string"==typeof e)try{return JSON.parse(e)}catch(e){throw new t("Invalid JSON in request body")}return"object"==typeof e&&null!==e?e:{}}buildUrlWithParams(e,t){const i=new URL(e);for(const[e,s]of Object.entries(t))i.searchParams.set(e,String(s));return i.toString()}};const k=new class{constructor(){this.responseCache=new Map}async validateResponse(e,i){const s=performance.now();if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const r={};let n;e.headers.forEach((e,t)=>{r[t]=e});const a=e.headers.get("content-type")||"";if(a.includes("application/json"))n=await this.parseJsonResponse(e,i);else if(a.includes("application/javascript")&&"jsonp"===i?.format)n=await this.parseJsonpResponse(e);else{if(!a.includes("application/xml")||"xml"!==i?.format)throw new t(`Unsupported response content type: ${a}`);n=await this.parseXmlResponse(e)}const o=performance.now()-s,c={data:n,status:e.status,headers:r,responseTime:o,rateLimit:this.extractRateLimitInfo(r)};return i?.cache?.enabled&&this.cacheResponse(e.url,n,i.cache.ttlMs),c}async parseJsonResponse(e,i){const s=await e.text();if(!s.trim())return null;try{const e=JSON.parse(s);return i?.schema&&this.validateSchema(e,i.schema),e}catch(e){throw new t(`Invalid JSON response: ${e.message}`)}}async parseJsonpResponse(e){const i=(await e.text()).match(/^\w+\((.*)\)$/);if(!i)throw new t("Invalid JSONP response format");try{return JSON.parse(i[1])}catch(e){throw new t(`Invalid JSON in JSONP response: ${e.message}`)}}async parseXmlResponse(e){const i=await e.text();if("undefined"!=typeof DOMParser){const e=(new DOMParser).parseFromString(i,"text/xml");if(e.getElementsByTagName("parsererror").length>0)throw new t("Invalid XML response");return this.xmlToJson(e.documentElement)}throw new t("XML parsing not available in this environment")}xmlToJson(e){const t={};if(e.attributes.length>0){t["@attributes"]={};for(let i=0;i<e.attributes.length;i++){const s=e.attributes[i];t["@attributes"][s.name]=s.value}}if(e.children.length>0)for(let i=0;i<e.children.length;i++){const s=e.children[i],r=s.tagName;t[r]||(t[r]=[]),t[r].push(this.xmlToJson(s))}else if(e.textContent)return e.textContent.trim();return t}transformToResults(e,t){if(!e)return[];let i=e;if(t?.dataPath&&(i=this.extractDataFromPath(e,t.dataPath)),!Array.isArray(i)){if("object"!=typeof i||null===i)return[];i=[i]}return i.map((e,i)=>({id:this.extractId(e,i),data:this.applyFieldMappings(e,t?.fieldMappings),score:1,matchedFields:[],metadata:{source:"api",originalIndex:i}}))}extractDataFromPath(e,t){const i=t.split(".");let s=e;for(const e of i){if(!s||"object"!=typeof s||!(e in s))return null;s=s[e]}return s}extractId(e,t){if(!e||"object"!=typeof e)return`api-result-${t}`;const i=e;for(const e of["id","_id","uuid","key"])if(e in i&&"string"==typeof i[e])return i[e];return`api-result-${t}`}applyFieldMappings(e,t){if(!t||!e||"object"!=typeof e)return e;const i=e,s={};for(const[e,r]of Object.entries(t))r in i&&(s[e]=i[r]);for(const[e,r]of Object.entries(i))Object.values(t).includes(e)||(s[e]=r);return s}validateSchema(e,i){if(i.required&&Array.isArray(i.required)){if(!e||"object"!=typeof e)throw new t("Response data must be an object");const s=e;for(const e of i.required)if(!(e in s))throw new t(`Required field '${e}' missing from response`)}}extractRateLimitInfo(e){const t={limit:0,remaining:0,reset:0},i=["x-ratelimit-limit","x-rate-limit-limit","ratelimit-limit"],s=["x-ratelimit-remaining","x-rate-limit-remaining","ratelimit-remaining"],r=["x-ratelimit-reset","x-rate-limit-reset","ratelimit-reset"];for(const s of i)if(e[s]){t.limit=parseInt(e[s],10)||0;break}for(const i of s)if(e[i]){t.remaining=parseInt(e[i],10)||0;break}for(const i of r)if(e[i]){const s=parseInt(e[i],10);t.reset=s>1e9?s:1e3*s;break}return t.limit>0?t:void 0}cacheResponse(e,t,i){this.responseCache.set(e,{data:t,timestamp:Date.now()+i}),this.cleanupCache()}getCachedResponse(e){const t=this.responseCache.get(e);return t?Date.now()>t.timestamp?(this.responseCache.delete(e),null):t.data:null}cleanupCache(){const e=Date.now();for(const[t,i]of this.responseCache.entries())e>i.timestamp&&this.responseCache.delete(t)}clearCache(){this.responseCache.clear()}isErrorResponse(e){return e.status>=400||e.data&&"object"==typeof e.data&&"error"in e.data}extractErrorMessage(e){if(e.status>=400)return`HTTP ${e.status}`;if(e.data&&"object"==typeof e.data){const t=e.data;for(const e of["error","message","errorMessage","error_description"])if(e in t&&"string"==typeof t[e])return t[e]}return"Unknown API error"}};class M{constructor(e={}){this.slidingWindows=new Map,this.clientStates=new Map,this.config={algorithm:"sliding_window",windowSizeMs:6e4,maxRequests:100,burstAllowance:20,crossTabSync:!0,storageKey:"rate_limit_state",gracePeriodMs:5e3,...e},this.startCleanup(),this.config.crossTabSync&&"undefined"!=typeof window&&this.initializeCrossTabSync()}getOrCreateSlidingWindow(e){let t=this.slidingWindows.get(e);return t||(t={requests:[],windowStart:Date.now()-this.newConfig.windowSizeMs,lastCleanup:Date.now()},this.slidingWindows.set(e,t)),t}getOrCreateClientState(e){let t=this.clientStates.get(e);return t||(t={clientId:e,totalRequests:0,blockedRequests:0,lastRequestTime:0,requestHistory:[],createdAt:Date.now()},this.clientStates.set(e,t)),t}getOrCreateBucket(e){let t=this.buckets.get(e);return t||(t={tokens:this.config.burstLimit,capacity:this.config.burstLimit,refillRate:this.config.requestsPerSecond,lastRefill:Date.now(),lastRequest:0},this.buckets.set(e,t)),t}canMakeRequest(){return this.refillBucket(),this.bucket.tokens>0}async waitForPermission(e=0){if(this.canMakeRequest())return void this.consumeToken();const t=this.calculateBackoffDelay();if(!(t>0&&(await this.delay(t),this.canMakeRequest()))){if(this.requestQueue.length>=this.config.queueSize)throw new Error("Rate limit queue is full");return this.queueRequest(e)}this.consumeToken()}getStatus(){this.refillBucket();const e=this.estimateQueueWait();return{remaining:Math.floor(this.bucket.tokens),limit:this.bucket.capacity,reset:this.calculateResetTime(),windowStart:this.bucket.lastRefill,shouldQueue:!this.canMakeRequest(),queueWaitMs:e>0?e:void 0}}reportViolation(e){if(this.lastViolation=Date.now(),this.bucket.tokens=Math.max(0,this.bucket.tokens-1),this.backoffMultiplier=Math.min(2*this.backoffMultiplier,10),e){const t=e>1e9?e:1e3*e;this.bucket.lastRefill=Math.min(this.bucket.lastRefill,t-6e4)}}updateFromHeaders(e){const t=this.extractHeaderValue(e,["x-ratelimit-limit","x-rate-limit-limit"]),i=this.extractHeaderValue(e,["x-ratelimit-remaining","x-rate-limit-remaining"]),s=this.extractHeaderValue(e,["x-ratelimit-reset","x-rate-limit-reset"]);if(null!==t&&(this.bucket.capacity=t,this.config.requestsPerSecond=t),null!==i&&(this.bucket.tokens=Math.min(i,this.bucket.tokens)),null!==s){const e=s>1e9?s:1e3*s;this.bucket.lastRefill=Math.max(this.bucket.lastRefill,e-6e4)}}clearQueue(){for(const e of this.requestQueue)e.reject(new Error("Request queue cleared"));this.requestQueue=[]}getQueueLength(){return this.requestQueue.length}reset(){this.bucket.tokens=this.config.burstLimit,this.bucket.lastRefill=Date.now(),this.backoffMultiplier=1,this.lastViolation=0,this.clearQueue()}refillBucket(){const e=Date.now(),t=(e-this.bucket.lastRefill)/1e3;if(t>0){const i=t*this.bucket.refillRate;this.bucket.tokens=Math.min(this.bucket.capacity,this.bucket.tokens+i),this.bucket.lastRefill=e}}consumeToken(){this.bucket.tokens>0&&(this.bucket.tokens-=1)}queueRequest(e){return new Promise((t,i)=>{const s={id:this.generateRequestId(),queuedAt:Date.now(),resolve:t,reject:i,priority:e},r=this.requestQueue.findIndex(t=>t.priority<e);-1===r?this.requestQueue.push(s):this.requestQueue.splice(r,0,s),this.processQueue()})}async processQueue(){if(!this.processingQueue&&0!==this.requestQueue.length){for(this.processingQueue=!0;this.requestQueue.length>0;)if(this.refillBucket(),this.bucket.tokens>0){const e=this.requestQueue.shift();this.consumeToken(),e.resolve()}else{const e=Math.max(100,1e3/this.bucket.refillRate);await this.delay(e)}this.processingQueue=!1}}calculateBackoffDelay(){if(0===this.lastViolation)return 0;const e=Date.now()-this.lastViolation,t=this.config.initialBackoffMs*this.backoffMultiplier;if(e>6e4)return this.backoffMultiplier=1,0;let i=0;switch(this.config.backoffStrategy){case"exponential":i=Math.min(t,this.config.maxBackoffMs);break;case"linear":i=Math.min(this.config.initialBackoffMs*this.backoffMultiplier,this.config.maxBackoffMs);break;case"fixed":i=this.config.initialBackoffMs}return Math.max(0,i-e)}estimateQueueWait(){if(0===this.requestQueue.length)return 0;const e=this.requestQueue.length/this.bucket.refillRate*1e3;return Math.max(0,e)}calculateResetTime(){const e=(this.bucket.capacity-this.bucket.tokens)/this.bucket.refillRate;return Date.now()+1e3*e}extractHeaderValue(e,t){for(const i of t){const t=e[i.toLowerCase()];if(t){const e=parseInt(t,10);return isNaN(e)?null:e}}return null}generateRequestId(){return`req-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}delay(e){return new Promise(t=>setTimeout(t,e))}}const A=new class{constructor(){this.limiters=new Map}getLimiter(e,t){return this.limiters.has(e)||this.limiters.set(e,new M(t)),this.limiters.get(e)}removeLimiter(e){const t=this.limiters.get(e);t&&(t.clearQueue(),this.limiters.delete(e))}clearAll(){for(const e of this.limiters.values())e.clearQueue();this.limiters.clear()}getActiveEndpoints(){return Array.from(this.limiters.keys())}};const I=new class{constructor(){this.corsCache=new Map,this.jsonpCallbacks=new Map,this.callbackCounter=0}async determineRequestMethod(e,t){if(!e.cors?.enabled)return{config:t,mode:"cors"};if(await this.checkCORSSupport(t.url,e.cors))return{config:this.addCORSHeaders(t,e.cors),mode:"cors"};if(e.cors.jsonpCallback&&"GET"===t.method)return{config:this.convertToJSONP(t,e.cors.jsonpCallback),mode:"jsonp"};if(e.cors.proxyUrl)return{config:this.convertToProxy(t,e.cors.proxyUrl),mode:"proxy"};throw new Error(`CORS not supported and no fallback configured for ${t.url}`)}async checkCORSSupport(e,t){const i=new URL(e).origin;if(this.corsCache.has(i))return this.corsCache.get(i);try{const s=await this.performPreflightCheck(e,t);return this.corsCache.set(i,s),s}catch(e){return this.corsCache.set(i,!1),!1}}async performPreflightCheck(e,t){try{const i=await fetch(e,{method:"OPTIONS",headers:{"Access-Control-Request-Method":t.allowedMethods?.[0]||"GET","Access-Control-Request-Headers":t.allowedHeaders?.join(", ")||"Content-Type",Origin:window.location.origin},mode:"cors"});if(i.ok){const e=i.headers.get("Access-Control-Allow-Origin");return"*"===e||e===window.location.origin}return!1}catch(e){return!1}}addCORSHeaders(e,t){const i={...e.headers};return i.Origin=window.location.origin,t.allowedHeaders&&t.allowedHeaders.forEach(e=>{i[e]||"origin"===e.toLowerCase()||(i[e]="")}),{...e,headers:i}}convertToJSONP(e,i){if("GET"!==e.method)throw new t("JSONP only supports GET requests");const s=new URL(e.url),r=this.generateCallbackName();return s.searchParams.set(i,r),{...e,url:s.toString(),headers:{...e.headers,"Content-Type":"application/javascript"}}}convertToProxy(e,t){const i={url:e.url,method:e.method,headers:e.headers,body:e.body};return{url:t,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),timeout:e.timeout}}async executeJSONPRequest(e){return new Promise((t,i)=>{const s=performance.now(),r=new URL(e.url),n=r.searchParams.get("callback")||r.searchParams.get("jsonp");if(!n)return void i(new Error("JSONP callback parameter not found in URL"));const a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=e.url,window[n]=e=>{const i=performance.now()-s;document.head.removeChild(a),delete window[n],t({data:e,status:200,headers:{"Content-Type":"application/javascript"},responseTime:i})},a.onerror=()=>{a.parentNode&&document.head.removeChild(a),delete window[n],i(new Error("JSONP request failed"))},e.timeout&&setTimeout(()=>{a.parentNode&&(document.head.removeChild(a),delete window[n],i(new Error("JSONP request timeout")))},e.timeout),document.head.appendChild(a)})}async executeProxyRequest(e){const t=performance.now();try{const i=await fetch(e.url,{method:e.method,headers:e.headers,body:e.body,signal:e.timeout?AbortSignal.timeout(e.timeout):void 0}),s=performance.now()-t,r=await i.json();return{data:r.body||r.data,status:r.status||i.status,headers:r.headers||{},responseTime:s}}catch(e){throw new Error(`Proxy request failed: ${e.message}`)}}generateCallbackName(){return`jsonp_callback_${Date.now()}_${++this.callbackCounter}`}isCORSError(e){const t=e.message.toLowerCase();return t.includes("cors")||t.includes("cross-origin")||t.includes("access-control")}async handleCORSError(e,t,i){if(!t.cors?.autoFallback||!this.isCORSError(i))throw i;const s=new URL(e.url).origin;this.corsCache.set(s,!1);try{const{config:i,mode:s}=await this.determineRequestMethod(t,e);if("jsonp"===s)return await this.executeJSONPRequest(i);if("proxy"===s)return await this.executeProxyRequest(i);throw new Error("No fallback method available")}catch(e){throw new Error(`CORS error and fallback failed: ${e.message}`)}}validateCORSConfig(e){if(e.enabled&&e.jsonpCallback&&0===e.jsonpCallback.trim().length)throw new t("JSONP callback parameter name cannot be empty");if(e.enabled&&e.proxyUrl)try{new URL(e.proxyUrl)}catch(e){throw new t("Invalid proxy URL")}if(e.allowedMethods){const i=["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"];for(const s of e.allowedMethods)if(!i.includes(s.toUpperCase()))throw new t(`Invalid HTTP method: ${s}`)}}clearCache(){this.corsCache.clear()}getCacheStatus(){const e={};for(const[t,i]of this.corsCache.entries())e[t]=i;return e}isBrowser(){return"undefined"!=typeof window&&"undefined"!=typeof document}getCurrentOrigin(){return this.isBrowser()?window.location.origin:"http://localhost"}};class q extends i{constructor(e){super("api"),this.responseCache=new Map;const i=e;if(!i)throw new t("APIAdapter requires configuration");this.config=i,this.validateConfiguration()}async connect(e){await this.validateConfig(e);const t=`api-${Date.now()}-${Math.random().toString(36).substring(2,11)}`;let i,s={};if(e.auth)try{s=await R.getAuthHeaders(e.auth,e.url)}catch(e){throw this.createError(`Authentication failed: ${e.message}`,"security","AUTH_FAILED",e)}e.rateLimit&&(i=A.getLimiter(e.url,e.rateLimit)),e.cors?.enabled&&I.validateCORSConfig(e.cors);const r={...this.createConnection(t,{endpoint:e.url,method:e.method||"GET",authType:e.auth?.type||"none"}),baseURL:e.url,defaultHeaders:{...s,...e.headers},auth:e.auth?{type:e.auth.type,token:e.auth.bearer?.token||e.auth.apiKey?.key,expiresAt:e.auth.bearer?.expiresAt}:void 0,rateLimiter:i?{remainingRequests:i.getStatus().remaining,resetTime:i.getStatus().reset,windowStart:i.getStatus().windowStart}:void 0,corsMode:"cors"};return this.updateConnectionStatus(t,"connected"),r}async query(e,t){const i=e;return this.executeWithMetrics(e.id,async()=>{const e=this.getCacheKey(i,t);if(this.config.response?.cache?.enabled){const t=this.getCachedResults(e);if(t)return t}if(i.rateLimiter&&this.config.rateLimit){const e=A.getLimiter(i.baseURL,this.config.rateLimit);await e.waitForPermission();const t=e.getStatus();i.rateLimiter={remainingRequests:t.remaining,resetTime:t.reset,windowStart:t.windowStart}}const s=x.transformRequest(t,this.config,i.defaultHeaders);let r,n=s,a="cors";if(this.config.cors?.enabled){const e=await I.determineRequestMethod(this.config,s);n=e.config,a=e.mode,i.corsMode=a}try{r="jsonp"===a?await I.executeJSONPRequest(n):"proxy"===a?await I.executeProxyRequest(n):await this.executeStandardRequest(n)}catch(e){if(!this.config.cors?.autoFallback||!I.isCORSError(e))throw this.createError(`API request failed: ${e.message}`,"network","REQUEST_FAILED",e,{query:t.original});r=await I.handleCORSError(s,this.config,e)}if(r.rateLimit&&this.config.rateLimit){A.getLimiter(i.baseURL,this.config.rateLimit).updateFromHeaders({"x-ratelimit-limit":r.rateLimit.limit.toString(),"x-ratelimit-remaining":r.rateLimit.remaining.toString(),"x-ratelimit-reset":r.rateLimit.reset.toString()})}const o=await k.validateResponse(this.createMockResponse(r),this.config.response);if(k.isErrorResponse(o)){const e=k.extractErrorMessage(o);throw this.createError(`API error: ${e}`,"adapter","API_ERROR",void 0,{query:t.original})}const c=k.transformToResults(o.data,this.config.response);return this.config.response?.cache?.enabled&&c.length>0&&this.cacheResults(e,c,this.config.response.cache.ttlMs),c},"query")}async disconnect(e){const t=e;this.config.auth&&R.clearTokenCache(),t.rateLimiter&&A.removeLimiter(t.baseURL),this.updateConnectionStatus(e.id,"disconnected"),this.removeConnection(e.id)}async validateConfig(e){const i=e;if("api"!==i.type)throw new t('Configuration type must be "api"');if(!i.url||"string"!=typeof i.url)throw new t("API URL is required and must be a string","url");try{new URL(i.url)}catch(e){throw new t("Invalid API URL format","url")}if(i.method&&!["GET","POST","PUT","DELETE"].includes(i.method))throw new t("Invalid HTTP method","method");i.auth&&this.validateAuthConfig(i.auth),i.requestTransform&&x.validateTransformConfig(i.requestTransform),i.cors?.enabled&&I.validateCORSConfig(i.cors),i.rateLimit&&this.validateRateLimitConfig(i.rateLimit)}getCapabilities(){return{supportsPooling:!0,supportsRealTime:!1,supportsPagination:!0,supportsSorting:!1,supportsFiltering:!0,maxConcurrentConnections:this.config.rateLimit?.requestsPerSecond||10,supportedQueryTypes:["text","partial","exact","graphql"]}}async executeStandardRequest(e){performance.now();const t={method:e.method,headers:e.headers};e.body&&(t.body=String(e.body)),e.timeout&&(t.signal=AbortSignal.timeout(e.timeout));const i=await fetch(e.url,t);return performance.now(),k.validateResponse(i,this.config.response)}createMockResponse(e){return{ok:e.status>=200&&e.status<300,status:e.status,statusText:this.getStatusText(e.status),headers:new Headers(e.headers),json:async()=>e.data,text:async()=>JSON.stringify(e.data)}}getStatusText(e){return{200:"OK",201:"Created",400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",429:"Too Many Requests",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable"}[e]||"Unknown"}validateAuthConfig(e){if(!["none","apikey","bearer","oauth2","basic"].includes(e.type))throw new t("Invalid authentication type");switch(e.type){case"apikey":if(!e.apiKey?.key)throw new t("API key is required for apikey authentication");break;case"bearer":if(!e.bearer?.token)throw new t("Bearer token is required for bearer authentication");break;case"oauth2":if(!e.oauth2?.clientId||!e.oauth2?.tokenUrl)throw new t("Client ID and token URL are required for OAuth2");break;case"basic":if(!e.basic?.username||!e.basic?.password)throw new t("Username and password are required for basic authentication")}}validateRateLimitConfig(e){if(!e.requestsPerMinute||e.requestsPerMinute<=0)throw new t("Requests per minute must be a positive number");if(e.queueSize&&e.queueSize<0)throw new t("Queue size must be non-negative");if(e.backoffStrategy&&!["exponential","linear","fixed"].includes(e.backoffStrategy))throw new t("Invalid backoff strategy")}getCacheKey(e,t){const i={url:e.baseURL,query:t.normalized,headers:e.defaultHeaders};return btoa(JSON.stringify(i))}getCachedResults(e){const t=this.responseCache.get(e);return t?Date.now()>t.expires?(this.responseCache.delete(e),null):t.data:null}cacheResults(e,t,i){if(this.responseCache.set(e,{data:t,expires:Date.now()+i}),this.responseCache.size>100){const e=this.responseCache.keys().next().value;this.responseCache.delete(e)}}validateConfiguration(){if(!this.config.url)throw new t("API URL is required");try{new URL(this.config.url)}catch(e){throw new t("Invalid API URL format")}}getConfig(){return{...this.config}}clearCache(){this.responseCache.clear()}}const P=new Map([["ENOTFOUND",{type:"network",code:"DNS_RESOLUTION_FAILED",retryable:!0,suggestions:["Check network connectivity","Verify URL/hostname"],fallbackOptions:["Use cached results"]}],["ECONNREFUSED",{type:"connection",code:"CONNECTION_REFUSED",retryable:!0,suggestions:["Check if service is running","Verify port configuration"],fallbackOptions:["Try alternative endpoint"]}],["ETIMEDOUT",{type:"timeout",code:"CONNECTION_TIMEOUT",retryable:!0,suggestions:["Increase timeout","Check network latency"],fallbackOptions:["Use cached results"]}],["400",{type:"validation",code:"BAD_REQUEST",retryable:!1,suggestions:["Check request format","Verify query parameters"]}],["401",{type:"security",code:"UNAUTHORIZED",retryable:!1,suggestions:["Check authentication credentials","Verify API key"]}],["403",{type:"security",code:"FORBIDDEN",retryable:!1,suggestions:["Check access permissions","Verify authorization scope"]}],["404",{type:"query",code:"NOT_FOUND",retryable:!1,suggestions:["Verify endpoint URL","Check resource existence"]}],["429",{type:"security",code:"RATE_LIMITED",retryable:!0,suggestions:["Reduce request frequency","Implement request throttling"],fallbackOptions:["Use cached results"]}],["500",{type:"adapter",code:"INTERNAL_SERVER_ERROR",retryable:!0,suggestions:["Try again later","Check service status"]}],["502",{type:"network",code:"BAD_GATEWAY",retryable:!0,suggestions:["Try again later","Check upstream service"],fallbackOptions:["Use alternative endpoint"]}],["503",{type:"adapter",code:"SERVICE_UNAVAILABLE",retryable:!0,suggestions:["Try again later","Check service maintenance status"],fallbackOptions:["Use cached results"]}],["ER_ACCESS_DENIED_ERROR",{type:"security",code:"DB_ACCESS_DENIED",retryable:!1,suggestions:["Check database credentials","Verify user permissions"]}],["ER_BAD_DB_ERROR",{type:"validation",code:"DB_NOT_FOUND",retryable:!1,suggestions:["Verify database name","Check database exists"]}],["ER_NO_SUCH_TABLE",{type:"validation",code:"TABLE_NOT_FOUND",retryable:!1,suggestions:["Verify table name","Check table exists"]}],["PROTOCOL_CONNECTION_LOST",{type:"connection",code:"DB_CONNECTION_LOST",retryable:!0,suggestions:["Check database server status","Verify network connectivity"],fallbackOptions:["Reconnect with new connection"]}],["QUERY_BLOCKED",{type:"security",code:"MALICIOUS_QUERY_BLOCKED",retryable:!1,suggestions:["Review query content","Remove suspicious patterns"]}],["XSS_DETECTED",{type:"security",code:"XSS_ATTACK_DETECTED",retryable:!1,suggestions:["Remove script tags","Sanitize input"]}],["SQL_INJECTION_DETECTED",{type:"security",code:"SQL_INJECTION_DETECTED",retryable:!1,suggestions:["Remove SQL keywords","Use parameterized queries"]}],["ELEMENT_NOT_FOUND",{type:"query",code:"DOM_ELEMENT_NOT_FOUND",retryable:!1,suggestions:["Check CSS selector","Verify element exists"]}],["INVALID_SELECTOR",{type:"validation",code:"INVALID_CSS_SELECTOR",retryable:!1,suggestions:["Fix CSS selector syntax","Use valid selector format"]}]]);const L=new class{constructor(){this.customMappings=new Map}mapError(e,t,i){const s=this.extractBaseError(e),r=this.findMapping(s),n=new Error(s.message);return n.type=r.type,n.code=r.code,n.originalError=e instanceof Error?e:void 0,n.context={adapter:t,timestamp:Date.now(),...i},n.recovery={retryable:r.retryable,suggestions:r.suggestions,fallbackOptions:r.fallbackOptions},n}registerMapping(e,t){this.customMappings.set(e,t)}isRetryable(e){const t=this.extractBaseError(e);return this.findMapping(t).retryable}getRecoverySuggestions(e){const t=this.extractBaseError(e);return this.findMapping(t).suggestions}extractBaseError(e){if(e instanceof Error)return{message:e.message,code:e.code,statusCode:e.status||e.statusCode};if("object"==typeof e&&null!==e){const t=e;return{message:String(t.message||t.error||"Unknown error"),code:String(t.code||""),statusCode:Number(t.status||t.statusCode||0)||void 0}}return{message:String(e||"Unknown error")}}findMapping(e){if(e.code){const t=this.customMappings.get(e.code);if(t)return t}if(e.code){const t=P.get(e.code);if(t)return t}if(e.statusCode){const t=P.get(String(e.statusCode));if(t)return t}const t=e.message.toLowerCase();return t.includes("timeout")?P.get("ETIMEDOUT"):t.includes("connection refused")||t.includes("econnrefused")?P.get("ECONNREFUSED"):t.includes("not found")||t.includes("enotfound")?P.get("ENOTFOUND"):t.includes("unauthorized")?P.get("401"):t.includes("forbidden")?P.get("403"):t.includes("rate limit")?P.get("429"):{type:"adapter",code:"UNKNOWN_ERROR",retryable:!0,suggestions:["Check logs for more details","Try again later"],fallbackOptions:["Use cached results"]}}getRegisteredErrorTypes(){return[...Array.from(P.keys()),...Array.from(this.customMappings.keys())]}clearCustomMappings(){this.customMappings.clear()}};class D{constructor(e,t,i={}){this.pool=new Map,this.waitingQueue=[],this.isDestroyed=!1,this.adapterType=e,this.factory=t,this.config={maxConnections:10,idleTimeoutMs:3e4,connectionTimeoutMs:1e4,acquireTimeoutMs:5e3,validateOnAcquire:!0,validateOnRelease:!1,retry:{attempts:3,backoffMs:1e3,maxBackoffMs:1e4},...i},this.startIdleCheck()}async acquire(e){if(this.isDestroyed)throw L.mapError(new Error("Connection pool has been destroyed"),this.adapterType,{config:e});const t=await this.findIdleConnection();return t?this.prepareConnection(t,e):this.pool.size<this.config.maxConnections?this.createNewConnection(e):this.waitForConnection(e)}async release(e){const t=this.pool.get(e.id);if(t){if(t.inUse=!1,t.lastUsed=Date.now(),t.useCount++,this.config.validateOnRelease){if(!await this.factory.validateConnection(e).catch(()=>!1))return void await this.removeConnection(e.id)}this.processWaitingQueue()}else await this.factory.destroyConnection(e).catch(()=>{})}async withConnection(e,t){const i=await this.acquire(e);try{return await t(i)}finally{await this.release(i)}}async executeWithRetry(e,t){let i,s=this.config.retry.backoffMs;for(let r=1;r<=this.config.retry.attempts;r++)try{return await this.withConnection(e,t)}catch(t){if(i=L.mapError(t,this.adapterType,{config:e,attempt:r,maxAttempts:this.config.retry.attempts}),!i.recovery?.retryable||r===this.config.retry.attempts)throw i;await this.delay(s),s=Math.min(2*s,this.config.retry.maxBackoffMs)}throw i}getStats(){const e=Array.from(this.pool.values()).filter(e=>!e.inUse).length,t=this.pool.size-e;return{totalConnections:this.pool.size,idleConnections:e,activeConnections:t,waitingRequests:this.waitingQueue.length,poolConfig:{...this.config}}}async destroy(){if(this.isDestroyed)return;this.isDestroyed=!0,this.idleCheckInterval&&clearInterval(this.idleCheckInterval);const e=L.mapError(new Error("Connection pool destroyed"),this.adapterType);this.waitingQueue.forEach(({reject:t})=>t(e)),this.waitingQueue.length=0;const t=Array.from(this.pool.values()).map(async({connection:e})=>{try{await this.factory.destroyConnection(e)}catch{}});await Promise.allSettled(t),this.pool.clear()}async findIdleConnection(){for(const[e,t]of this.pool.entries())if(!t.inUse){if(this.config.validateOnAcquire){if(!await this.factory.validateConnection(t.connection).catch(()=>!1)){await this.removeConnection(e);continue}}return t.connection}return null}async createNewConnection(e){try{const t=await Promise.race([this.factory.createConnection(e),this.createTimeoutPromise(this.config.connectionTimeoutMs)]),i={connection:t,lastUsed:Date.now(),inUse:!0,createdAt:Date.now(),useCount:0};return this.pool.set(t.id,i),t}catch(t){throw L.mapError(t,this.adapterType,{config:e})}}async waitForConnection(e){return new Promise((t,i)=>{const s=setTimeout(()=>{const s=this.waitingQueue.findIndex(e=>e.resolve===t);s>=0&&this.waitingQueue.splice(s,1),i(L.mapError(new Error("Connection acquire timeout"),this.adapterType,{config:e,timeout:this.config.acquireTimeoutMs}))},this.config.acquireTimeoutMs);this.waitingQueue.push({resolve:e=>{clearTimeout(s),t(e)},reject:e=>{clearTimeout(s),i(e)},timestamp:Date.now()})})}async processWaitingQueue(){if(0===this.waitingQueue.length)return;const e=await this.findIdleConnection();if(!e)return;const t=this.waitingQueue.shift();if(t){this.pool.get(e.id).inUse=!0,t.resolve(e)}}prepareConnection(e,t){const i=this.pool.get(e.id);return i.inUse=!0,i.lastUsed=Date.now(),e.lastUsedAt=Date.now(),e.metadata={...e.metadata,config:t},e}async removeConnection(e){const t=this.pool.get(e);t&&(this.pool.delete(e),await this.factory.destroyConnection(t.connection).catch(()=>{}))}startIdleCheck(){this.idleCheckInterval=setInterval(()=>{const e=Date.now(),t=[];for(const[i,s]of this.pool.entries())!s.inUse&&e-s.lastUsed>this.config.idleTimeoutMs&&t.push(i);t.forEach(e=>this.removeConnection(e).catch(()=>{}))},this.config.idleTimeoutMs/2)}createTimeoutPromise(e){return new Promise((t,i)=>{setTimeout(()=>{i(new Error(`Operation timed out after ${e}ms`))},e)})}delay(e){return new Promise(t=>setTimeout(t,e))}}class O{constructor(){this.adapters=new Map}createAdapter(e,t){const i=this.adapters.get(e);if(!i)throw L.mapError(new Error(`No adapter registered for type: ${e}`),"factory",{config:t});return new i(t)}registerAdapter(e,t){this.adapters.set(e,t)}getRegisteredTypes(){return Array.from(this.adapters.keys())}}class z{constructor(e={}){this.pools=new Map,this.adapters=new Map,this.rateLimits=new Map,this.performanceMetrics=[],this.factory=new O,this.securityConfig={validateInput:!0,sanitizeQueries:!0,rateLimitRpm:1e3,logSecurityEvents:!0,...e}}registerAdapter(e,t){this.factory.registerAdapter(e,t)}getRegisteredTypes(){return this.factory.getRegisteredTypes()}async connect(e){const t=performance.now();try{await this.validateConfig(e),this.securityConfig.validateInput&&this.validateSecurityConfig(e);const i=this.getAdapter(e.type,e);if(e.pooling?.enabled){const t=this.getConnectionPool(e.type,i);return await t.acquire(e)}const s=await i.connect(e);return this.recordConnectionMetrics({connectionTime:performance.now()-t,queryTime:0,totalTime:performance.now()-t,success:!0,resultCount:0}),s}catch(i){throw this.recordConnectionMetrics({connectionTime:performance.now()-t,queryTime:0,totalTime:performance.now()-t,success:!1,resultCount:0}),L.mapError(i,e.type,{config:e})}}async query(e,t){const i=performance.now();try{this.checkRateLimit(e.adapterType),this.securityConfig.sanitizeQueries&&await this.validateQuerySecurity(t);const s=this.adapters.get(e.adapterType);if(!s)throw L.mapError(new Error(`No adapter found for connection type: ${e.adapterType}`),e.adapterType,{adapter:e.adapterType,query:t.original});const r=await s.query(e,t);return this.recordConnectionMetrics({connectionTime:0,queryTime:performance.now()-i,totalTime:performance.now()-i,success:!0,resultCount:r.length}),r}catch(s){throw this.recordConnectionMetrics({connectionTime:0,queryTime:performance.now()-i,totalTime:performance.now()-i,success:!1,resultCount:0}),L.mapError(s,e.adapterType,{adapter:e.adapterType,query:t.original})}}async disconnect(e){try{const t=this.adapters.get(e.adapterType);t&&await t.disconnect(e)}catch(t){throw L.mapError(t,e.adapterType,{adapter:e.adapterType})}}async executeQuery(e,t){if(e.pooling?.enabled){const i=this.getAdapter(e.type,e),s=this.getConnectionPool(e.type,i);return await s.executeWithRetry(e,async e=>await this.query(e,t))}const i=await this.connect(e);try{return await this.query(i,t)}finally{await this.disconnect(i).catch(()=>{})}}async testConnection(e){const t=performance.now();try{const i=await this.connect(e),s=performance.now()-t,r=this.adapters.get(e.type),n=!r||await r.healthCheck(i);return await this.disconnect(i),{success:n,latency:s,...r?.getCapabilities()?{capabilities:r.getCapabilities()}:{}}}catch(i){return{success:!1,latency:performance.now()-t,error:L.mapError(i,e.type,{config:e})}}}getPerformanceMetrics(){return[...this.performanceMetrics]}clearPerformanceMetrics(){this.performanceMetrics.length=0}getConnectionPoolStats(){const e={};for(const[t,i]of this.pools.entries())e[t]=i.getStats();return e}async destroy(){const e=Array.from(this.pools.values()).map(e=>e.destroy());await Promise.allSettled(e),this.pools.clear();const t=Array.from(this.adapters.values()).map(e=>e.destroy());await Promise.allSettled(t),this.adapters.clear(),this.performanceMetrics.length=0,this.rateLimits.clear()}async createConnection(e){const t=this.getAdapter(e.type,e);return await t.connect(e)}async validateConnection(e){const t=this.adapters.get(e.adapterType);return!!t&&await t.healthCheck(e)}async destroyConnection(e){await this.disconnect(e)}getAdapter(e,t){if(!this.adapters.has(e)){const i=this.factory.createAdapter(e,t);this.adapters.set(e,i)}return this.adapters.get(e)}getConnectionPool(e,t){if(!this.pools.has(e)){const t=new D(e,this,{maxConnections:10,idleTimeoutMs:3e4,connectionTimeoutMs:1e4,acquireTimeoutMs:5e3,validateOnAcquire:!0,validateOnRelease:!1,retry:{attempts:3,backoffMs:1e3,maxBackoffMs:1e4}});this.pools.set(e,t)}return this.pools.get(e)}async validateConfig(e){if(!e.type)throw L.mapError(new Error("Data source type is required"),"validation",{config:e});if(!this.factory.getRegisteredTypes().includes(e.type))throw L.mapError(new Error(`Unsupported data source type: ${e.type}`),"validation",{config:e,supportedTypes:this.factory.getRegisteredTypes()});const t=this.getAdapter(e.type,e);await t.validateConfig(e)}validateSecurityConfig(e){const t=e.security;if(t&&("sql"===e.type||"api"===e.type)&&!t.validateInput)throw L.mapError(new Error("Input validation is required for SQL and API adapters"),"security",{config:e})}async validateQuerySecurity(e){const t=l(e.normalized,{xssProtection:!0,sqlInjectionProtection:!0});if(!t.isSecure){const i=[];t.threats.xss&&i.push("XSS"),t.threats.sqlInjection&&i.push("SQL Injection");const s=L.mapError(new Error(`Security threats detected: ${i.join(", ")}`),"security",{query:e,threats:t.threats});throw this.securityConfig.logSecurityEvents,s}}checkRateLimit(e){const t=Date.now(),i=e,s=this.rateLimits.get(i)||{count:0,resetTime:t+6e4};if(t>s.resetTime&&(s.count=0,s.resetTime=t+6e4),s.count++,this.rateLimits.set(i,s),s.count>this.securityConfig.rateLimitRpm)throw L.mapError(new Error(`Rate limit exceeded for ${e}: ${s.count}/${this.securityConfig.rateLimitRpm} requests per minute`),"security",{adapterType:e,currentCount:s.count,limit:this.securityConfig.rateLimitRpm,resetTime:s.resetTime})}recordConnectionMetrics(e){this.performanceMetrics.push(e),this.performanceMetrics.length>1e3&&this.performanceMetrics.splice(0,this.performanceMetrics.length-1e3)}}function _(){const e=new z,{MemoryAdapter:t}=require("../adapters/MemoryAdapter"),{APIAdapter:i}=require("../adapters/APIAdapter");return e.registerAdapter("memory",t),e.registerAdapter("api",i),e}const U=_(),N="1.0.0";function $(e,t){return new S(e,t)}export{q as APIAdapter,e as DEFAULT_CONFIG,z as DataSourceConnector,s as MemoryAdapter,h as QueryProcessor,d as ResponseTransformer,p as ResultsDropdown,m as SearchInput,S as UniversalSearch,N as VERSION,t as ValidationError,_ as createDataSourceConnector,$ as createSearchComponent,U as dataSourceConnector};
//# sourceMappingURL=index.esm.js.map
